---
/* src/components/common/CookieConsent.astro */
import 'vanilla-cookieconsent/dist/cookieconsent.css';
---

<style is:global>
  :root {
    --cc-bg: #ffffff;
    --cc-text: #1e293b;
    --cc-btn-primary-bg: #10B981;
    --cc-btn-primary-text: #ffffff;
    --cc-btn-secondary-bg: #e2e8f0;
    --cc-btn-secondary-text: #475569;
  }
  
  .dark {
    --cc-bg: #0f172a;
    --cc-text: #cbd5e1;
    --cc-btn-primary-bg: #10B981;
    --cc-btn-secondary-bg: #334155;
    --cc-btn-secondary-text: #cbd5e1;
  }
</style>

<script>
  import * as CookieConsent from 'vanilla-cookieconsent';

  /**
   * Wir definieren die Übersetzung global außerhalb der Funktion,
   * damit sie beim Re-Init sofort im Speicher bereitsteht.
   */
  const TRANSLATIONS = {
    de: {
      consent_modal: {
        title: 'Wir verwenden Cookies',
        description: 'Cookies helfen uns bei der Bereitstellung unserer Dienste.',
        primary_btn: { text: 'Alle akzeptieren', role: 'accept_all' },
        secondary_btn: { text: 'Einstellungen', role: 'settings' }
      },
      preferences_modal: {
        title: 'Cookie Einstellungen',
        accept_all_btn: 'Alle akzeptieren',
        reject_all_btn: 'Alle ablehnen',
        save_btn: 'Speichern',
        close_btn_label: 'Schließen',
        sections: [
          { title: 'Notwendig', description: 'Technisch erforderlich.', linked_category: 'necessary' },
          { title: 'Analytics', description: 'Besucher-Statistiken.', linked_category: 'analytics' }
        ]
      }
    },
    en: {
      consent_modal: {
        title: 'We use cookies',
        description: 'Cookies help us provide our services.',
        primary_btn: { text: 'Accept all', role: 'accept_all' },
        secondary_btn: { text: 'Settings', role: 'settings' }
      },
      preferences_modal: {
        title: 'Cookie Settings',
        accept_all_btn: 'Accept all',
        reject_all_btn: 'Reject all',
        save_btn: 'Save',
        close_btn_label: 'Close',
        sections: [
          { title: 'Necessary', description: 'Technically essential.', linked_category: 'necessary' },
          { title: 'Analytics', description: 'Visitor statistics.', linked_category: 'analytics' }
        ]
      }
    }
  };

  const startConsent = async () => {
    // 1. DOM-Bereinigung: Aggressiver
    const modal = document.getElementById('cc-main');
    if (modal) modal.remove();
    document.documentElement.classList.remove('cc--active');

    // 2. Warte auf Idle (Browser hat nichts mehr zu tun)
    if ('requestIdleCallback' in window) {
      // @ts-ignore
      window.requestIdleCallback(runLib);
    } else {
      setTimeout(runLib, 200);
    }
  };

  const runLib = async () => {
    try {
      const htmlLang = document.documentElement.lang?.split('-')[0] || 'de';
      const activeLang = TRANSLATIONS[htmlLang] ? htmlLang : 'de';

      await CookieConsent.run({
        root: 'body', // Explizit auf Body setzen
        auto_detect: false,
        mode: 'opt-in',
        gui_options: {
          consent_modal: { layout: 'box', position: 'bottom right' },
          preferences_modal: { layout: 'box', position: 'right' }
        },
        categories: {
          necessary: { readOnly: true, enabled: true },
          analytics: { enabled: false }
        },
        language: {
          default: 'de',
          current: activeLang,
          translations: TRANSLATIONS
        }
      });
    } catch (err) {
      // Wenn es hier kracht, dann liegt es an einem Library-Konflikt
      console.error("Critical CC Error:", err);
    }
  };

  // Click-Delegation (Einmalig auf Document)
  if (!(window as any).cc_listener_attached) {
    document.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      if (!target) return;

      if (target.closest('[data-cc="show-preferencesModal"]')) {
        e.preventDefault();
        try { CookieConsent.showPreferences(); } catch { startConsent(); }
      }

      const langLink = target.closest("[data-lang]") as HTMLElement;
      if (langLink) {
        e.preventDefault();
        const lang = langLink.dataset.lang;
        document.cookie = `preferred_language=${lang}; path=/; max-age=31536000; SameSite=Lax${location.protocol === "https:" ? "; Secure" : ""}`;
        window.location.href = `/${lang}/${window.location.search}${window.location.hash}`;
      }
    });
    (window as any).cc_listener_attached = true;
  }

  // Astro Integration
  document.addEventListener('astro:page-load', startConsent);
  if (document.readyState !== 'loading') startConsent();
</script>
