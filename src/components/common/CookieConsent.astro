---
/* src/components/common/CookieConsent.astro */
---

<link rel="stylesheet" href="/libs/cookieconsent.css" />
<link rel="stylesheet" href="/libs/cookie-custom.css" />

<div id="cookie-consent-root"></div>

<script type="module">
  // Hilfsfunktion: Externes Script nur einmal laden
  function loadLibrary(src) {
    return new Promise((resolve, reject) => {
      if (document.querySelector(`script[src="${src}"]`)) {
        resolve();
        return;
      }
      const script = document.createElement('script');
      script.src = src;
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  async function initCookieBanner() {
    const root = document.getElementById('cookie-consent-root');
    if (!root) return;

    try {
      // 1️⃣ Library laden, falls nicht vorhanden
      if (!window.CookieConsent) {
        await loadLibrary('/libs/cookieconsent.umd.js');
      }

      // 2️⃣ Konfiguration importieren
      const { config } = await import('/libs/cookieconsent-config.js');

      // 3️⃣ Library starten oder resetten
      if (window.CookieConsent) {
        window.CookieConsent.reset(false);
        window.CookieConsent.run({ ...config, root });
        // Alias für v3 API
        window.CC = window.CC || window.CookieConsent;
      }
    } catch (e) {
      console.error('CookieConsent Fehler:', e);
    }
  }

  // Banner initialisieren bei Astro View Transitions
  document.addEventListener('astro:page-load', initCookieBanner);
</script>

<script type="module">
  document.addEventListener('DOMContentLoaded', () => {
    // ✅ Alle Language-Links korrekt auswählen
    const langLinks = document.querySelectorAll<HTMLAnchorElement>('[data-lang]');
    langLinks.forEach((link) => {
      link.addEventListener('click', () => {
        const lang = link.dataset.lang;
        if (!lang) return;

        // ✅ CookieConsent v3 kompatibel
        if (window.CC && typeof window.CC.setCookie === 'function') {
          window.CC.setCookie('preferred_language', lang, {
            necessary: true, // immer erlaubt
            path: '/',
            maxAge: 60 * 60 * 24 * 365 // 1 Jahr
          });
        } else {
          // Fallback: normales JS-Cookie
          document.cookie = `preferred_language=${lang}; path=/; max-age=${60*60*24*365}; SameSite=Lax`;
        }

        // Optional: localStorage für bestehendes Redirect-Script
        try { localStorage.setItem('lang', lang); } catch(e) {}
      });
    });
  });
</script>