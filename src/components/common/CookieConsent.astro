---
/* src/components/common/CookieConsent.astro */
---

<link rel="stylesheet" href="/libs/cookieconsent.css" />
<link rel="stylesheet" href="/libs/cookie-custom.css" />

<script is:inline src="/libs/cookieconsent.umd.js"></script>

<script is:inline>
async function initCookieBanner() {
  if (!window.CookieConsent) {
    setTimeout(initCookieBanner, 100);
    return;
  }

  try {
    const { config } = await import('/libs/cookieconsent-config.js');
    const currentLang = document.documentElement.lang?.split('-')[0] || 'de';

    // 1. Consent Banner starten
    window.CookieConsent.run({
      ...config,
      language: {
        ...config.language,
        current: currentLang
      }
    });

    // 2. Button manuell neu verknüpfen (Fix für Astro View Transitions)
    // Wir suchen nach allen Elementen mit deinem spezifischen Data-Attribut
    const settingsTriggers = document.querySelectorAll('[data-cc="show-preferencesModal"]');

    settingsTriggers.forEach(trigger => {
      // WICHTIG: Klonen entfernt eventuelle alte Event-Listener, die stören könnten
      // und sorgt für ein sauberes Element.
      const newTrigger = trigger.cloneNode(true);
      trigger.parentNode.replaceChild(newTrigger, trigger);

      // Neuen Click-Listener hinzufügen
      newTrigger.addEventListener('click', (e) => {
        e.preventDefault(); // Verhindert das "Scroll to Top" (href="#")
        window.CookieConsent.showPreferences(); // Öffnet das Modal
      });
    });

  } catch (e) {
    console.error("CookieConsent Fehler:", e);
  }
}

document.addEventListener('astro:page-load', initCookieBanner);
</script>

<script is:inline>
document.addEventListener("click", function (event) {
  const link = event.target.closest("[data-lang]");
  if (!link) return;

  event.preventDefault();

  const lang = link.dataset.lang;
  if (lang !== "de" && lang !== "en") return;

  const isProd = location.protocol === "https:";

  document.cookie =
    "preferred_language=" + lang +
    "; path=/; max-age=31536000; SameSite=Lax" +
    (isProd ? "; Secure" : "");

  const query = window.location.search || "";
  const hash = window.location.hash || "";

  window.location.href = "/" + lang + "/" + query + hash;
});
</script>