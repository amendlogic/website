---
/* src/components/common/CookieConsent.astro */
---

<link rel="stylesheet" href="/libs/cookieconsent.css" />
<link rel="stylesheet" href="/libs/cookie-custom.css" />

<script is:inline src="/libs/cookieconsent.umd.js"></script>

<script is:inline>
  // ==============================
  // SPRACH-LOGIK (robust & konsistent)
  // ==============================
  function getCurrentLang() {
    const htmlLang = document.documentElement.lang;
    const pageLang = htmlLang
      ? htmlLang.split('-')[0].toLowerCase()
      : null;

    // ðŸ‘‰ Auf Sprachseiten entscheidet DIE SEITE
    if (pageLang === "en" || pageLang === "de") {
      return pageLang;
    }

    // ðŸ‘‰ Nur sonst (z.B. auf /) zÃ¤hlt der Cookie
    const m = document.cookie.match(/preferred_language=([^;]+)/);
    if (m && (m[1] === "de" || m[1] === "en")) {
      return m[1];
    }

    // Internationaler Fallback
    return "en";
  }

  // ==============================
  // COOKIECONSENT INITIALISIEREN
  // ==============================
  async function initCookieBanner() {
    if (!window.CookieConsent) {
      setTimeout(initCookieBanner, 100);
      return;
    }

    try {
      const { config } = await import('/libs/cookieconsent-config.js');
      const lang = getCurrentLang();

      // Vorherige UI nur zurÃ¼cksetzen (Cookie bleibt!)
      window.CookieConsent.reset(false);

      window.CookieConsent.run({
        ...config,
        language: {
          ...config.language,
          current: lang
        }
      });

      // Optional global verfÃ¼gbar machen
      window.CC = window.CookieConsent;

    } catch (e) {
      console.error("CookieConsent Fehler:", e);
    }
  }

  // ==============================
  // ASTRO VIEW TRANSITIONS SAFE
  // ==============================
  document.addEventListener('astro:page-load', initCookieBanner);

  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    initCookieBanner();
  } else {
    document.addEventListener('DOMContentLoaded', initCookieBanner);
  }
</script>