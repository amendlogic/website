---
/* src/components/common/CookieConsent.astro */
---

<link rel="stylesheet" href="/libs/cookieconsent.css" />
<link rel="stylesheet" href="/libs/cookie-custom.css" />

<script is:inline src="/libs/cookieconsent.umd.js"></script>

<script is:inline>
// 1. Der Klick-Handler (Event Delegation)
// Dieser k체mmert sich um das Abfangen des Klicks
function handleCookieClick(e) {
  const trigger = e.target.closest('[data-cc="show-preferencesModal"]');
  
  if (trigger) {
    e.preventDefault(); // Stoppt das "Springen"
    
    // Sicherheitscheck: Existiert das Modal im DOM?
    if (window.CookieConsent && document.getElementById('cc-main')) {
        window.CookieConsent.showPreferences();
    } else {
        console.warn("CookieConsent noch nicht bereit oder GUI fehlt.");
        // Fallback: Versuchen wir es in 100ms nochmal, falls das Skript noch l채dt
        setTimeout(() => window.CookieConsent?.showPreferences(), 100);
    }
  }
}

// Listener nur einmal global registrieren
if (!window.cookieListenerAttached) {
  document.addEventListener('click', handleCookieClick);
  window.cookieListenerAttached = true;
}

// 2. Die Initialisierung (Muss bei JEDEM Seitenwechsel laufen)
async function initCookieBanner() {
  if (!window.CookieConsent) {
    setTimeout(initCookieBanner, 100);
    return;
  }

  try {
    const { config } = await import('/libs/cookieconsent-config.js');
    const currentLang = document.documentElement.lang?.split('-')[0] || 'de';

    // --- WICHTIG: Reset f체r Astro View Transitions ---
    // Wir resetten den internen State, damit das Skript merkt, 
    // dass das HTML neu gebaut werden muss.
    // KEIN "true" 체bergeben, sonst sind die User-Cookies weg!
    window.CookieConsent.reset(); 

    window.CookieConsent.run({
      ...config,
      language: {
        ...config.language,
        current: currentLang
      }
    });

  } catch (e) {
    console.error("CookieConsent Fehler:", e);
  }
}

document.addEventListener('astro:page-load', initCookieBanner);
</script>

<script is:inline>
document.addEventListener("click", function (event) {
  const link = event.target.closest("[data-lang]");
  if (!link) return;

  event.preventDefault();

  const lang = link.dataset.lang;
  if (lang !== "de" && lang !== "en") return;

  const isProd = location.protocol === "https:";

  document.cookie =
    "preferred_language=" + lang +
    "; path=/; max-age=31536000; SameSite=Lax" +
    (isProd ? "; Secure" : "");

  const query = window.location.search || "";
  const hash = window.location.hash || "";

  window.location.href = "/" + lang + "/" + query + hash;
});
</script>

<script is:inline>
document.addEventListener("DOMContentLoaded", () => {
  const meta = document.querySelector('meta[name="theme-color"]');
  if (meta) meta.content = "transparent";
});
</script>