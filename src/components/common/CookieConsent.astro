<script>
  // Wir importieren die Library hier NICHT statisch oben, 
  // um Namenskonflikte beim Bündeln zu vermeiden.

  const TRANSLATIONS = {
    de: {
      consent_modal: {
        title: 'Wir verwenden Cookies',
        description: 'Cookies helfen uns bei der Bereitstellung unserer Dienste.',
        primary_btn: { text: 'Alle akzeptieren', role: 'accept_all' },
        secondary_btn: { text: 'Einstellungen', role: 'settings' }
      },
      preferences_modal: {
        title: 'Cookie Einstellungen',
        accept_all_btn: 'Alle akzeptieren',
        reject_all_btn: 'Alle ablehnen',
        save_btn: 'Speichern',
        close_btn_label: 'Schließen',
        sections: [
          { title: 'Notwendig', description: 'Technisch erforderlich.', linked_category: 'necessary' },
          { title: 'Analytics', description: 'Besucher-Statistiken.', linked_category: 'analytics' }
        ]
      }
    },
    en: {
      consent_modal: {
        title: 'We use cookies',
        description: 'Cookies help us provide our services.',
        primary_btn: { text: 'Accept all', role: 'accept_all' },
        secondary_btn: { text: 'Settings', role: 'settings' }
      },
      preferences_modal: {
        title: 'Cookie Settings',
        accept_all_btn: 'Accept all',
        reject_all_btn: 'Reject all',
        save_btn: 'Save',
        close_btn_label: 'Close',
        sections: [
          { title: 'Necessary', description: 'Technically essential.', linked_category: 'necessary' },
          { title: 'Analytics', description: 'Visitor statistics.', linked_category: 'analytics' }
        ]
      }
    }
  };

  async function runConsent() {
    try {
      // 1. Dynamischer Import direkt in der Funktion
      const CC = await import('vanilla-cookieconsent');
      const CookieConsent = CC.default || CC;

      // 2. DOM-Cleanup
      const old = document.getElementById('cc-main');
      if (old) old.remove();

      // 3. Sprache ermitteln
      const htmlLang = document.documentElement.lang?.split('-')[0] || 'de';
      const activeLang = TRANSLATIONS[htmlLang] ? htmlLang : 'de';

      // 4. Initialisierung
      await CookieConsent.run({
        auto_detect: false,
        mode: 'opt-in',
        gui_options: {
          consent_modal: { layout: 'box', position: 'bottom right' },
          preferences_modal: { layout: 'box', position: 'right' }
        },
        categories: {
          necessary: { readOnly: true, enabled: true },
          analytics: { enabled: false }
        },
        language: {
          default: 'de',
          current: activeLang,
          translations: TRANSLATIONS
        }
      });

      // 5. Globales Objekt für Klick-Handler verfügbar machen
      window.CC_INSTANCE = CookieConsent;
      
    } catch (err) {
      console.error("Fatal CC Error:", err);
    }
  }

  // Zentraler Click-Listener (einmalig)
  if (!window.CC_LISTENER_SET) {
    document.addEventListener('click', (e) => {
      const target = e.target;
      if (!target) return;

      if (target.closest('[data-cc="show-preferencesModal"]')) {
        e.preventDefault();
        if (window.CC_INSTANCE) {
          window.CC_INSTANCE.showPreferences();
        } else {
          runConsent().then(() => window.CC_INSTANCE?.showPreferences());
        }
      }

      const langLink = target.closest("[data-lang]");
      if (langLink) {
        e.preventDefault();
        const lang = langLink.dataset.lang;
        document.cookie = `preferred_language=${lang}; path=/; max-age=31536000; SameSite=Lax${location.protocol === "https:" ? "; Secure" : ""}`;
        window.location.href = `/${lang}/${window.location.search}${window.location.hash}`;
      }
    });
    window.CC_LISTENER_SET = true;
  }

  // Astro Integration mit Sicherheitsabstand
  document.addEventListener('astro:page-load', () => {
    setTimeout(runConsent, 200);
  });

  // Initialer Start
  if (document.readyState !== 'loading') {
    setTimeout(runConsent, 500);
  }
</script>
