---
/* src/components/common/CookieConsent.astro */

// 1. CSS direkt aus dem npm-Paket importieren
import 'vanilla-cookieconsent/dist/cookieconsent.css';
---

<div id="cc-container"></div>

<script>
  import * as CookieConsent from 'vanilla-cookieconsent';

  // --- KONFIGURATION ---
  const config = {
    // FIX 1: Wir nutzen einen expliziten Container statt document.body
    root: '#cc-container',

    gui_options: {
      consent_modal: {
        layout: 'box',
        position: 'bottom right',
        equal_weight_buttons: true,
        flip_buttons: false
      },
      preferences_modal: {
        layout: 'box',
        position: 'right',
        equal_weight_buttons: true,
        flip_buttons: false
      }
    },
    categories: {
      necessary: {
        readOnly: true,
        enabled: true
      },
      analytics: {
        enabled: false,
        autoClear: {
          cookies: [
            { name: /^_ga/ }, // Google Analytics Regex
            { name: '_gid' }
          ]
        }
      }
    },
    language: {
      default: 'de',
      auto_detect: false, // FIX 2: Manuelle Kontrolle, um Abstürze bei unbekannten Sprachen zu verhindern
      translations: {
        de: {
          consent_modal: {
            title: 'Wir verwenden Cookies',
            description: 'Wir nutzen Cookies, um das Nutzererlebnis zu verbessern.',
            primary_btn: { text: 'Alle akzeptieren', role: 'accept_all' },
            secondary_btn: { text: 'Einstellungen', role: 'settings' }
          },
          preferences_modal: {
            title: 'Cookie Einstellungen',
            accept_all_btn: 'Alle akzeptieren',
            reject_all_btn: 'Alle ablehnen',
            save_btn: 'Speichern',
            close_btn_label: 'Schließen',
            sections: [
              { title: 'Notwendige Cookies', description: 'Technisch essenziell für die Webseite.', linked_category: 'necessary' },
              { title: 'Analyse Cookies', description: 'Helfen uns zu verstehen, wie Besucher die Seite nutzen.', linked_category: 'analytics' }
            ]
          }
        },
        en: {
          consent_modal: {
            title: 'We use cookies',
            description: 'We use cookies to enhance your user experience.',
            primary_btn: { text: 'Accept all', role: 'accept_all' },
            secondary_btn: { text: 'Settings', role: 'settings' }
          },
          preferences_modal: {
            title: 'Cookie Settings',
            accept_all_btn: 'Accept all',
            reject_all_btn: 'Reject all',
            save_btn: 'Save',
            close_btn_label: 'Close',
            sections: [
              { title: 'Necessary', description: 'Technically essential.', linked_category: 'necessary' },
              { title: 'Analytics', description: 'Visitor statistics.', linked_category: 'analytics' }
            ]
          }
        }
      }
    }
  };

  // --- EVENT HANDLERS ---
  
  // Handler 1: Klick auf "Cookie Einstellungen" Link im Footer/Menü
  const handlePreferencesClick = (e) => {
    const trigger = e.target.closest('[data-cc="show-preferencesModal"]');
    if (trigger) {
      e.preventDefault();
      CookieConsent.showPreferences();
    }
  };

  // Handler 2: Sprachumschalter Logik (Deine Custom Logik)
  const handleLanguageSwitch = (event) => {
    const link = event.target.closest("[data-lang]");
    if (!link) return;

    event.preventDefault();
    const lang = link.dataset.lang;
    
    // Sicherheitscheck: Nur erlaubte Sprachen
    if (lang !== "de" && lang !== "en") return;

    const isProd = location.protocol === "https:";

    // Cookie setzen
    document.cookie = `preferred_language=${lang}; path=/; max-age=31536000; SameSite=Lax${isProd ? "; Secure" : ""}`;

    // Redirect mit Query Params & Hash
    const query = window.location.search || "";
    const hash = window.location.hash || "";
    window.location.href = `/${lang}/${query}${hash}`;
  };


  // --- INITIALISIERUNG ---
  const init = async () => {
    // FIX 3: Prüfen, ob der Container existiert (verhindert Fehler beim Hydration)
    const container = document.getElementById('cc-container');
    if (!container) return;

    // Sprache sicher ermitteln (Fallback auf 'de', wenn unbekannt)
    const htmlLang = document.documentElement.lang?.split('-')[0];
    const supportedLangs = ['de', 'en'];
    const currentLang = supportedLangs.includes(htmlLang) ? htmlLang : 'de';

    try {
      // FIX 4: Altes Banner entfernen (Zombie-Elemente von Astro Transitions löschen)
      // Das löst den "Cannot read properties of undefined"-Fehler oft aus.
      if(document.getElementById('cc-main')) {
          document.getElementById('cc-main').remove();
      }

      // Banner starten
      await CookieConsent.run({
        ...config,
        language: {
          ...config.language,
          current: currentLang
        }
      });
      
    } catch (e) {
      console.error("CookieConsent Init Error:", e);
    }

    // Event Listener aufräumen und neu setzen (verhindert doppelte Listener)
    document.removeEventListener('click', handlePreferencesClick);
    document.addEventListener('click', handlePreferencesClick);

    document.removeEventListener('click', handleLanguageSwitch);
    document.addEventListener('click', handleLanguageSwitch);
  };

  // --- ASTRO LIFECYCLE HOOKS ---
  // Feuert bei jedem Seitenwechsel (View Transitions)
  document.addEventListener('astro:page-load', init);
  
  // Fallback für den allerersten Load, falls astro:page-load zu spät kommt
  if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
  } else {
      // Falls das Skript nachträglich geladen wird
      init();
  }
</script>
