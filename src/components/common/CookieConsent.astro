---
/* src/components/common/CookieConsent.astro */
---

<link rel="stylesheet" href="/libs/cookieconsent.css" />
<link rel="stylesheet" href="/libs/cookie-custom.css" />

<div id="cookie-consent-root"></div>

<script type="module">
  // --- Hilfsfunktion: Externes Script nur einmal laden ---
  function loadLibrary(src) {
    return new Promise((resolve, reject) => {
      if (document.querySelector(`script[src="${src}"]`)) {
        resolve();
        return;
      }
      const script = document.createElement('script');
      script.src = src;
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  // --- CookieConsent Banner initialisieren ---
  async function initCookieBanner() {
    const root = document.getElementById('cookie-consent-root');
    if (!root) return;

    try {
      if (!window.CookieConsent) {
        await loadLibrary('/libs/cookieconsent.umd.js');
      }

      const { config } = await import('/libs/cookieconsent-config.js');

      if (window.CookieConsent) {
        window.CookieConsent.reset(false); // Banner neu, Cookies bleiben
        window.CookieConsent.run({ ...config, root });
        window.CC = window.CC || window.CookieConsent; // Alias für v3 API
      }
    } catch (e) {
      console.error('CookieConsent Fehler:', e);
    }
  }

  // --- Language-Link-Bindung ---
  function bindLanguageLinks() {
    const langLinks = document.querySelectorAll<HTMLAnchorElement>('[data-lang]');
    if (!langLinks || langLinks.length === 0) return;

    langLinks.forEach((link) => {
      // Doppeltes Binden vermeiden
      if ((link as any)._bound) return;
      (link as any)._bound = true;

      link.addEventListener('click', () => {
        const lang = link.dataset.lang;
        if (!lang) return;

        // CookieConsent v3 kompatibel
        if (window.CC && typeof window.CC.setCookie === 'function') {
          window.CC.setCookie('preferred_language', lang, {
            necessary: true,
            path: '/',
            maxAge: 60 * 60 * 24 * 365 // 1 Jahr
          });
        } else {
          // Fallback: normales JS-Cookie
          document.cookie = `preferred_language=${lang}; path=/; max-age=${60*60*24*365}; SameSite=Lax`;
        }

        // Optional: localStorage für bestehendes Redirect-Script
        try { localStorage.setItem('lang', lang); } catch(e) {}
      });
    });
  }

  // --- Events binden ---
  document.addEventListener('DOMContentLoaded', () => {
    initCookieBanner();
    bindLanguageLinks();
  });

  // Astro View Transitions: Banner & Links erneut binden
  document.addEventListener('astro:page-load', () => {
    initCookieBanner();
    bindLanguageLinks();
  });
</script>