---
/* src/components/common/CookieConsent.astro */
---

<link rel="stylesheet" href="/libs/cookieconsent.css" />
<link rel="stylesheet" href="/libs/cookie-custom.css" />

<script is:inline src="/libs/cookieconsent.umd.js"></script>

<div id="cookie-consent-root"></div>

<script is:inline>
  // Funktion zum Starten des Banners
  async function initCookieBanner() {
    const root = document.getElementById('cookie-consent-root');
    if (!root) return;

    // Falls das externe Skript noch nicht geladen ist, kurz warten und nochmal versuchen
    if (!window.CookieConsent) {
      setTimeout(initCookieBanner, 100); 
      return;
    }

    try {
      // Config dynamisch laden
      // Der Pfad muss im Browser erreichbar sein (in public/libs/)
      const { config } = await import('/libs/cookieconsent-config.js');

      // WICHTIG: 'false' bedeutet: DOM zurücksetzen, aber Cookie BEHALTEN.
      // So wird der Banner nicht erneut angezeigt, wenn schon zugestimmt wurde.
      window.CookieConsent.reset(false);
      
      window.CookieConsent.run({ 
        ...config, 
        root: root 
      });
      
      // Global verfügbar machen
      window.CC = window.CookieConsent;

    } catch (e) {
      console.error('CookieConsent Start-Fehler:', e);
    }
  }

  // Funktion für Sprach-Umschalter
  function setupLanguageLinks() {
    // Wir nutzen Event Delegation am Body (funktioniert auch nach Seitenwechseln)
    document.body.addEventListener('click', (event) => {
      // Prüfen, ob das geklickte Element (oder ein Elternteil) das Attribut data-lang hat
      // @ts-ignore
      const link = event.target.closest('[data-lang]');
      
      if (link && link.dataset.lang) {
        const lang = link.dataset.lang;
        
        if (window.CC && typeof window.CC.setCookie === 'function') {
          window.CC.setCookie('preferred_language', lang, {
            necessary: true,
            path: '/',
            maxAge: 60 * 60 * 24 * 365
          });
        }
        
        // LocalStorage Fallback (optional)
        try { localStorage.setItem('lang', lang); } catch(e) {}
      }
    });
  }

  // --- Initialisierung ---

  // 1. Sprach-Links einmalig einrichten
  setupLanguageLinks();

  // 2. Banner bei jedem Astro-Seitenwechsel starten (View Transitions)
  document.addEventListener('astro:page-load', initCookieBanner);
  
  // 3. Fallback für den allerersten Start (falls astro:page-load nicht feuert oder verzögert ist)
  if (document.readyState === 'complete' || document.readyState === 'interactive') {
     initCookieBanner();
  } else {
     document.addEventListener('DOMContentLoaded', initCookieBanner);
  }
</script>
