---
import 'vanilla-cookieconsent/dist/cookieconsent.css';
import '~/assets/styles/cookie-custom.css';
---

<link rel="stylesheet" href="/libs/cookie-custom.css" />

<script>
  import * as CookieConsent from 'vanilla-cookieconsent';
  // Importiere Config UND die Sprachen
  import { config, SUPPORTED_LANGUAGES } from '../../lib/cookieconsent-config';

  // Dev-Mode Helper
  if (import.meta.env.DEV) window.CookieConsent = CookieConsent;

  // --- LOGIK ---

  const handleLanguageSwitch = (target) => {
    const newLang = target.dataset.lang;
    
    // 1. Sicherheitscheck mit zentraler Liste
    if (!SUPPORTED_LANGUAGES.includes(newLang)) return;

    // 2. Cookie setzen
    const isProd = location.protocol === "https:";
    document.cookie = `preferred_language=${newLang}; path=/; max-age=31536000; SameSite=Lax${isProd ? "; Secure" : ""}`;

    // 3. URL Umbau (Die optimierte Kurzform)
    const url = new URL(window.location.href);
    const segments = url.pathname.split('/').filter(Boolean);
    
    // Prüfen, ob das erste Segment eine bekannte Sprache ist
    const firstSegmentIsLang = SUPPORTED_LANGUAGES.includes(segments[0]);
    
    // Neue Segmente bauen: Entweder Sprache ersetzen oder vorne anfügen
    const newSegments = firstSegmentIsLang 
        ? [newLang, ...segments.slice(1)] 
        : [newLang, ...segments];

    url.pathname = '/' + newSegments.join('/');
    window.location.href = url.toString();
  };

  const handleGlobalClick = (e) => {
    // A. Cookie Einstellungen öffnen
    // closest() ist wichtig, falls der User auf ein Icon im Button klickt
    if (e.target.closest('[data-cc="show-preferencesModal"]')) {
        e.preventDefault();
        // Die kurze, sichere Variante:
        CookieConsent?.showPreferences(); 
        return;
    }

    // B. Sprachwechsel
    const langTrigger = e.target.closest('[data-lang]');
    if (langTrigger) {
        e.preventDefault();
        handleLanguageSwitch(langTrigger);
        return;
    }
  };

  const initBanner = () => {
    try {
        const currentLang = document.documentElement.lang?.split('-')[0] || 'de';

        // WICHTIG: reset(false) löst dein Problem!
        // true = Löscht alles (auch User-Entscheidung) -> Banner kommt immer wieder (BÖSE)
        // false = Löscht nur internen UI-State -> Banner kommt nicht, wenn Cookie da ist (GUT)
        CookieConsent.reset(false);

        CookieConsent.run({
            ...config,
            language: { ...config.language, current: currentLang }
        });
        
    } catch (err) {
        console.error("CookieConsent Init Error:", err);
    }
  };

  // --- EVENT LISTENER (Singleton Pattern) ---
  
  // Verhindert doppelte Listener im Dev-Modus (HMR)
  if (!window._ccListenerAttached) {
      document.addEventListener('click', handleGlobalClick);
      window._ccListenerAttached = true;
  }

  // Astro Navigation Support
  document.addEventListener('astro:page-load', initBanner);
</script>
