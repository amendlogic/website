---
/* src/components/common/CookieConsent.astro */
import 'vanilla-cookieconsent/dist/cookieconsent.css';
---

<style is:global>
  :root {
    --cc-bg: #ffffff;
    --cc-text: #1e293b;
    --cc-btn-primary-bg: #10B981;
    --cc-btn-primary-text: #ffffff;
    --cc-btn-secondary-bg: #e2e8f0;
    --cc-btn-secondary-text: #475569;
    --cc-font-family: inherit;
  }
  
  .dark {
    --cc-bg: #0f172a;
    --cc-text: #cbd5e1;
    --cc-btn-primary-bg: #10B981;
    --cc-btn-primary-text: #ffffff;
    --cc-btn-secondary-bg: #334155;
    --cc-btn-secondary-text: #cbd5e1;
    --cc-toggle-bg-on: #10B981;
    --cc-footer-bg: #0f172a;
  }
</style>

<script>
  import * as CookieConsent from 'vanilla-cookieconsent';

  const config = {
    // FIX: 'root' entfernt. Standardverhalten (Body) ist stabiler.
    // root: '#cc-container', 

    gui_options: {
      consent_modal: {
        layout: 'box',
        position: 'bottom right',
        equal_weight_buttons: true,
        flip_buttons: false
      },
      preferences_modal: {
        layout: 'box',
        position: 'right',
        equal_weight_buttons: true,
        flip_buttons: false
      }
    },
    categories: {
      necessary: {
        readOnly: true,
        enabled: true
      },
      analytics: {
        enabled: false,
        autoClear: {
          cookies: [
            { name: /^_ga/ },
            { name: '_gid' }
          ]
        }
      }
    },
    language: {
      default: 'de',
      auto_detect: false,
      translations: {
        de: {
          consent_modal: {
            title: 'Wir verwenden Cookies',
            description: 'Wir nutzen Cookies, um das Nutzererlebnis zu verbessern.',
            primary_btn: { text: 'Alle akzeptieren', role: 'accept_all' },
            secondary_btn: { text: 'Einstellungen', role: 'settings' }
          },
          preferences_modal: {
            title: 'Cookie Einstellungen',
            accept_all_btn: 'Alle akzeptieren',
            reject_all_btn: 'Alle ablehnen',
            save_btn: 'Speichern',
            close_btn_label: 'Schließen',
            sections: [
              { title: 'Notwendige Cookies', description: 'Technisch essenziell.', linked_category: 'necessary' },
              { title: 'Analyse Cookies', description: 'Statistiken.', linked_category: 'analytics' }
            ]
          }
        },
        en: {
          consent_modal: {
            title: 'We use cookies',
            description: 'We use cookies to enhance your user experience.',
            primary_btn: { text: 'Accept all', role: 'accept_all' },
            secondary_btn: { text: 'Settings', role: 'settings' }
          },
          preferences_modal: {
            title: 'Cookie Settings',
            accept_all_btn: 'Accept all',
            reject_all_btn: 'Reject all',
            save_btn: 'Save',
            close_btn_label: 'Close',
            sections: [
              { title: 'Necessary', description: 'Technically essential.', linked_category: 'necessary' },
              { title: 'Analytics', description: 'Visitor statistics.', linked_category: 'analytics' }
            ]
          }
        }
      }
    }
  };

  const handlePreferencesClick = (e) => {
    const trigger = e.target.closest('[data-cc="show-preferencesModal"]');
    if (trigger) {
      e.preventDefault();
      CookieConsent.showPreferences();
    }
  };

  const handleLanguageSwitch = (event) => {
    const link = event.target.closest("[data-lang]");
    if (!link) return;
    event.preventDefault();
    const lang = link.dataset.lang;
    if (lang !== "de" && lang !== "en") return;
    const isProd = location.protocol === "https:";
    document.cookie = `preferred_language=${lang}; path=/; max-age=31536000; SameSite=Lax${isProd ? "; Secure" : ""}`;
    const query = window.location.search || "";
    const hash = window.location.hash || "";
    window.location.href = `/${lang}/${query}${hash}`;
  };

  const init = async () => {
    // Sprache ermitteln
    const htmlLang = document.documentElement.lang?.split('-')[0];
    const supportedLangs = ['de', 'en'];
    const currentLang = supportedLangs.includes(htmlLang) ? htmlLang : 'de';

    try {
      // Clean Up: Falls durch Navigation noch Reste da sind
      if(document.body.classList.contains('c_darkmode')) {
          // Manchmal bleibt die Klasse hängen
      }
      
      // CookieConsent starten
      await CookieConsent.run({
        ...config,
        language: {
          ...config.language,
          current: currentLang
        }
      });
      
    } catch (e) {
      console.error("CookieConsent Init Error:", e);
    }

    // Listener (neu) binden
    document.removeEventListener('click', handlePreferencesClick);
    document.addEventListener('click', handlePreferencesClick);
    document.removeEventListener('click', handleLanguageSwitch);
    document.addEventListener('click', handleLanguageSwitch);
  };

  // Astro Lifecycle
  document.addEventListener('astro:page-load', init);
  
  // Safety Fallback: Falls astro:page-load nicht feuert oder wir beim ersten Load sind
  if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
  } else {
      init();
  }
</script>
