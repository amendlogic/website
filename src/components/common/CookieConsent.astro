---
// src/components/common/CookieConsent.astro
---

<link rel="stylesheet" href="/libs/cookieconsent.css" />
<link rel="stylesheet" href="/libs/cookie-custom.css" />

<div id="cookie-consent-root"></div>

<script type="module">
  // Hilfsfunktion: Lädt das externe Skript nur einmal
  function loadLibrary(src) {
    return new Promise((resolve, reject) => {
      if (document.querySelector(`script[src="${src}"]`)) {
        resolve(); // Skript ist schon da
        return;
      }
      const script = document.createElement('script');
      script.src = src;
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  async function initCookieBanner() {
    const root = document.getElementById('cookie-consent-root');
    // Wenn wir nicht im Browser sind oder kein Root da ist -> Abbruch
    if (!root) return;

    try {
      // 1. Lib laden (falls noch nicht global vorhanden)
      if (!window.CookieConsent) {
        await loadLibrary('/libs/cookieconsent.umd.js');
      }

      // 2. Config importieren
      // Wir nutzen einen dynamischen Import, damit der Code sauber bleibt
      const { config } = await import('/libs/cookieconsent-config.js');

      // 3. Initialisierung oder Reset
      if (window.CookieConsent) {
        // WICHTIG: reset(false) löscht nur das HTML-Overlay, aber BEHÄLT das Cookie!
        // Das verhindert, dass der Banner bei Seitenwechsel (View Transition) wieder aufpoppt.
        window.CookieConsent.reset(false);
        
        // Starten der Library
        window.CookieConsent.run({ 
          ...config, 
          // Falls deine Lib-Version "container" oder "root" unterstützt:
          root: root 
        });
      }

    } catch (e) {
      console.error("CookieConsent Fehler:", e);
    }
  }

  // Astro View Transitions Event: Feuert beim ersten Laden UND bei Navigation
  document.addEventListener('astro:page-load', initCookieBanner);
</script>
