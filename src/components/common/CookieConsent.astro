---
/* src/components/common/CookieConsent.astro */
---

<link rel="stylesheet" href="/libs/cookieconsent.css" />
<link rel="stylesheet" href="/libs/cookie-custom.css" />

<script is:inline src="/libs/cookieconsent.umd.js"></script>

<script is:inline>
// 1. Der Klick-Handler (Event Delegation)
// Wir definieren diese Funktion einmalig ausserhalb
function handleCookieClick(e) {
  // Prüfen: Wurde ein Element mit dem passenden Attribut geklickt?
  // .closest() ist wichtig, falls im Button noch ein <span> oder Icon ist
  const trigger = e.target.closest('[data-cc="show-preferencesModal"]');
  
  if (trigger) {
    e.preventDefault(); // Verhindert das Springen (Scroll-to-top)
    if (window.CookieConsent) {
        window.CookieConsent.showPreferences();
    }
  }
}

// Wir hängen den Listener nur EINMAL an das Dokument, nicht bei jedem Page-Load
if (!window.cookieListenerAttached) {
  document.addEventListener('click', handleCookieClick);
  window.cookieListenerAttached = true; // Markierung, damit wir es nicht doppelt machen
}

// 2. Die Initialisierung (Muss bei jedem Page-Load laufen, da das Modal-HTML evtl. weg ist)
async function initCookieBanner() {
  if (!window.CookieConsent) {
    setTimeout(initCookieBanner, 100);
    return;
  }

  try {
    const { config } = await import('/libs/cookieconsent-config.js');
    const currentLang = document.documentElement.lang?.split('-')[0] || 'de';

    window.CookieConsent.run({
      ...config,
      language: {
        ...config.language,
        current: currentLang
      }
    });
    
    // HIER NICHTS MEHR TUN! Der globale Listener oben regelt das jetzt.

  } catch (e) {
    console.error("CookieConsent Fehler:", e);
  }
}

document.addEventListener('astro:page-load', initCookieBanner);
</script>

<script is:inline>
document.addEventListener("click", function (event) {
  const link = event.target.closest("[data-lang]");
  if (!link) return;

  event.preventDefault();

  const lang = link.dataset.lang;
  if (lang !== "de" && lang !== "en") return;

  const isProd = location.protocol === "https:";

  document.cookie =
    "preferred_language=" + lang +
    "; path=/; max-age=31536000; SameSite=Lax" +
    (isProd ? "; Secure" : "");

  const query = window.location.search || "";
  const hash = window.location.hash || "";

  window.location.href = "/" + lang + "/" + query + hash;
});
</script>