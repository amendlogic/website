---
// src/components/common/CookieConsent.astro
---

<link rel="stylesheet" href="/libs/cookieconsent.css" />
<link rel="stylesheet" href="/libs/cookie-custom.css" />

<script is:inline src="/libs/cookieconsent.umd.js"></script>

<script is:inline>
const COOKIE_NAME = "preferred_language";
const COOKIE_MAX_AGE = 60 * 60 * 24 * 365;

// --------------------------------------------------
// 1) CookieConsent starten (ohne eigenes Root-Element)
// --------------------------------------------------
async function initCookieBanner() {

  if (!window.CookieConsent) {
    setTimeout(initCookieBanner, 100);
    return;
  }

  try {
    const { config } = await import('/libs/cookieconsent-config.js');

    // UI neu zeichnen, Zustimmung behalten
    window.CookieConsent.reset(false);

    // ðŸ‘‰ Kein "root" mehr Ã¼bergeben â€“ Standard-Rendering in <body>
    window.CookieConsent.run({
      ...config
    });

    window.CC = window.CookieConsent;

  } catch (e) {
    console.error('[CookieConsent] Init failed:', e);
  }
}

// --------------------------------------------------
// 2) Sprache sauber als Cookie setzen
// --------------------------------------------------
function setPreferredLanguage(lang) {

  document.cookie =
    `${COOKIE_NAME}=${lang}; path=/; max-age=${COOKIE_MAX_AGE}; SameSite=Lax`;

  // Optional: Library synchronisieren (nur wenn geladen)
  if (window.CC && typeof window.CC.setCookie === 'function') {
    window.CC.setCookie(COOKIE_NAME, lang, {
      necessary: true,
      path: '/',
      maxAge: COOKIE_MAX_AGE
    });
  }

  try {
    localStorage.setItem('lang', lang);
  } catch {}
}

// --------------------------------------------------
// 3) Event Delegation fÃ¼r Sprachlinks
// --------------------------------------------------
document.body.addEventListener('click', (event) => {
  const link = event.target.closest('[data-lang]');
  if (!link || !link.dataset.lang) return;

  setPreferredLanguage(link.dataset.lang);
});

// --------------------------------------------------
// 4) Astro Lifecycle Hooks
// --------------------------------------------------
document.addEventListener('astro:page-load', initCookieBanner);

if (document.readyState === 'complete' || document.readyState === 'interactive') {
  initCookieBanner();
} else {
  document.addEventListener('DOMContentLoaded', initCookieBanner);
}
</script>