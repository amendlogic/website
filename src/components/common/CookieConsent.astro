---
import 'vanilla-cookieconsent/dist/cookieconsent.css';
import '~/assets/styles/cookie-custom.css';
---

<script>
  import * as CookieConsent from 'vanilla-cookieconsent';
  import { config, SUPPORTED_LANGUAGES } from '../../lib/cookieconsent-config';

  /**
   * DEV-Mode Helper
   * Macht CookieConsent in der Konsole verfügbar für Debugging (z.B. CookieConsent.showPreferences())
   */
  if (import.meta.env.DEV) {
    window.CookieConsent = CookieConsent;
  }

  // --- LOGIC: LANGUAGE SWITCHER ---

  const handleLanguageSwitch = (target) => {
    const newLang = target.dataset.lang;
    
    // 1. Validierung
    if (!SUPPORTED_LANGUAGES.includes(newLang)) return;

    // 2. Cookie setzen (Lax + Secure in Prod)
    const isProd = location.protocol === "https:";
    document.cookie = `preferred_language=${newLang}; path=/; max-age=31536000; SameSite=Lax${isProd ? "; Secure" : ""}`;

    // 3. URL umschreiben
    const url = new URL(window.location.href);
    const segments = url.pathname.split('/').filter(Boolean);
    const isFirstSegmentLang = SUPPORTED_LANGUAGES.includes(segments[0]);
    
    // Sprache austauschen oder hinzufügen
    const newSegments = isFirstSegmentLang 
        ? [newLang, ...segments.slice(1)] 
        : [newLang, ...segments];

    url.pathname = '/' + newSegments.join('/');
    window.location.href = url.toString();
  };

  // --- LOGIC: GLOBAL CLICK HANDLER ---

  /**
   * Zentraler Event-Delegator für Performance.
   * Fängt Klicks auf Cookie-Buttons und Sprachwechsler ab.
   */
  const handleGlobalClick = (e) => {
    // Case A: Cookie Einstellungen öffnen
    const cookieTrigger = e.target.closest('[data-cc="show-preferencesModal"]');
    if (cookieTrigger) {
        e.preventDefault();
        CookieConsent?.showPreferences(); 
        return;
    }

    // Case B: Sprache wechseln
    const langTrigger = e.target.closest('[data-lang]');
    if (langTrigger) {
        e.preventDefault();
        handleLanguageSwitch(langTrigger);
        return;
    }
  };

  // --- INIT: COOKIE CONSENT ---

  const initBanner = () => {
    try {
        const currentLang = document.documentElement.lang?.split('-')[0] || 'de';

        // Soft-Reset: Löscht internen UI-State (für View Transitions),
        // behält aber den User-Cookie (damit der Banner nicht nervt).
        CookieConsent.reset(false);

        CookieConsent.run({
            ...config,
            language: { 
              ...config.language, 
              current: currentLang 
            }
        });
        
    } catch (err) {
        console.error("[CookieConsent] Init Failed:", err);
    }
  };

  // --- LIFECYCLE & LISTENERS ---

  // 1. Global Listener (HMR Safe: Verhindert doppelte Registrierung im Dev-Mode)
  if (!window._ccListenerAttached) {
      document.addEventListener('click', handleGlobalClick);
      window._ccListenerAttached = true;
  }

  // 2. Astro Init (Feuert bei Initial Load und View Transitions)
  document.addEventListener('astro:page-load', initBanner);
</script>
