---
/* src/components/common/CookieConsent.astro */
---

<link rel="stylesheet" href="/libs/cookieconsent.css" />
<link rel="stylesheet" href="/libs/cookie-custom.css" />

<script is:inline src="/libs/cookieconsent.umd.js"></script>

<div id="cookie-consent-root"></div>

<script>
  // Wir importieren nur die Config dynamisch, da diese vermutlich Astro-spezifisch/modulär ist
  // Falls die Config auch eine reine JS-Datei in /libs/ ist, könnte man sie auch oben mit is:inline laden.
  // Wir gehen hier davon aus, dass sie ein ES-Modul ist.

  async function initCookieBanner() {
    const root = document.getElementById('cookie-consent-root');
    if (!root) return;

    // Sicherheits-Check: Warten bis die Library wirklich da ist (falls Netzwerk laggt)
    if (!window.CookieConsent) {
      // Kleiner Retry-Mechanismus, falls das externe Skript noch eine Millisekunde braucht
      setTimeout(initCookieBanner, 100); 
      return;
    }

    try {
      // Config laden
      const { config } = await import('/libs/cookieconsent-config.js');

      // Reset ist wichtig für Astro View Transitions (verhindert doppelte Banner)
      window.CookieConsent.reset(true);
      
      window.CookieConsent.run({ 
        ...config, 
        root: root 
      });
      
      // Alias setzen (falls nötig)
      window.CC = window.CookieConsent;

    } catch (e) {
      console.error('CookieConsent Start-Fehler:', e);
    }
  }

  function setupLanguageLinks() {
    // Event Delegation (Besser als Loop):
    // Wir hören auf den Body und prüfen, ob ein Klick von einem data-lang Element kam.
    // Das funktioniert auch bei Elementen, die dynamisch nachgeladen werden!
    document.body.addEventListener('click', (event) => {
      // @ts-ignore
      const link = event.target.closest('[data-lang]');
      
      if (link && link.dataset.lang) {
        const lang = link.dataset.lang;
        
        if (window.CC && typeof window.CC.setCookie === 'function') {
          window.CC.setCookie('preferred_language', lang, {
            necessary: true,
            path: '/',
            maxAge: 60 * 60 * 24 * 365
          });
        }
        // LocalStorage Fallback, rein kosmetisch
        try { localStorage.setItem('lang', lang); } catch(e) {}
      }
    });
  }

  // --- Initialisierung ---

  // Einmaliges Setup der Listener (reicht dank Event Delegation am Body)
  setupLanguageLinks();

  // Banner initialisieren bei jedem Seitenwechsel (wichtig für View Transitions)
  document.addEventListener('astro:page-load', initCookieBanner);
  
  // Fallback: Falls 'astro:page-load' nicht feuert (z.B. keine ViewTransitions),
  // starten wir es direkt, sobald dieses Skript läuft.
  if (document.readyState === 'complete' || document.readyState === 'interactive') {
     initCookieBanner();
  } else {
     document.addEventListener('DOMContentLoaded', initCookieBanner);
  }
</script>