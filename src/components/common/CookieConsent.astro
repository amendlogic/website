---
/* src/components/common/CookieConsent.astro */
---

<link rel="stylesheet" href="/libs/cookieconsent.css" />
<link rel="stylesheet" href="/libs/cookie-custom.css" />

<div id="cookie-consent-root"></div>

<script type="module">
  function loadLibrary(src) {
    return new Promise((resolve, reject) => {
      if (document.querySelector(`script[src="${src}"]`)) {
        resolve();
        return;
      }
      const script = document.createElement('script');
      script.src = src;
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  async function initCookieBanner() {
    const root = document.getElementById('cookie-consent-root');
    if (!root) return;

    try {
      if (!window.CookieConsent) {
        await loadLibrary('/libs/cookieconsent.umd.js');
      }

      const { config } = await import('/libs/cookieconsent-config.js');

      if (window.CookieConsent) {
        window.CookieConsent.reset(false);
        window.CookieConsent.run({ ...config, root });
        window.CC = window.CC || window.CookieConsent;
      }
    } catch (e) {
      console.error('CookieConsent Fehler:', e);
    }
  }

  function bindLanguageLinks() {
    const langLinks = document.querySelectorAll('[data-lang]');
    if (!langLinks || langLinks.length === 0) return;

    langLinks.forEach(function(link) {
      if (link._bound) return;
      link._bound = true;

      link.addEventListener('click', function() {
        const lang = link.dataset.lang;
        if (!lang) return;

        if (window.CC && typeof window.CC.setCookie === 'function') {
          window.CC.setCookie('preferred_language', lang, {
            necessary: true,
            path: '/',
            maxAge: 60 * 60 * 24 * 365
          });
        } else {
          document.cookie = `preferred_language=${lang}; path=/; max-age=${60*60*24*365}; SameSite=Lax`;
        }

        try { localStorage.setItem('lang', lang); } catch(e) {}
      });
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    initCookieBanner();
    bindLanguageLinks();
  });

  document.addEventListener('astro:page-load', function() {
    initCookieBanner();
    bindLanguageLinks();
  });
</script>