---
import { Icon } from "astro-icon/components";
---

<button
  id="theme-toggle"
  class="text-muted dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 
         focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 
         rounded-lg text-sm p-2.5 inline-flex items-center"
  aria-label="Toggle color mode"
>
  <span id="theme-icon">
    <Icon name="tabler:sun" class="w-6 h-6" />
  </span>
</button>

<script is:inline>
  const states = ["system", "light", "dark"];

  function getNext(state) {
    const i = states.indexOf(state);
    return states[(i + 1) % states.length];
  }

  const icons = {
    system: `<icon-element name="tabler:device-desktop" class="w-6 h-6"></icon-element>`,
    light: `<icon-element name="tabler:sun" class="w-6 h-6"></icon-element>`,
    dark: `<icon-element name="tabler:moon" class="w-6 h-6"></icon-element>`,
  };

  function applyTheme(theme) {
    if (theme === "system") {
      document.documentElement.classList.remove("dark");
      if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
        document.documentElement.classList.add("dark");
      }
    } else if (theme === "dark") {
      document.documentElement.classList.add("dark");
    } else {
      document.documentElement.classList.remove("dark");
    }
  }

  function updateIcon(theme) {
    const container = document.getElementById("theme-icon");
    container.innerHTML = icons[theme];
  }

  function toggleTheme() {
    const current = localStorage.getItem("theme") || "system";
    const next = getNext(current);

    localStorage.setItem("theme", next);
    applyTheme(next);
    updateIcon(next);
  }

  const initial = localStorage.getItem("theme") || "system";
  applyTheme(initial);
  updateIcon(initial);

  document.getElementById("theme-toggle").addEventListener("click", toggleTheme);
</script>
