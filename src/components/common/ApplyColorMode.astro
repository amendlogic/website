---
import { UI } from 'astrowind:config';
---

<script is:inline>
  const THEME_ORDER = ['system', 'light', 'dark'];

  function getTheme() {
    try {
      return localStorage.getItem('theme') ?? 'system';
    } catch {
      return 'system';
    }
  }

  function applyTheme(theme) {
    const root = document.documentElement;

    root.classList.remove('dark');
    if (theme === 'dark') root.classList.add('dark');
    if (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      root.classList.add('dark');
    }

    // Icon wechseln
    const icon = document.getElementById('theme-icon');
    if (!icon) return;

    switch (theme) {
      case 'light':
        icon.setAttribute('name', 'tabler:sun');
        break;
      case 'dark':
        icon.setAttribute('name', 'tabler:moon');
        break;
      default:
        icon.setAttribute('name', 'tabler:device-desktop');
    }
  }

  // Initial Theme setzen
  const defaultTheme = UI.theme || 'system';
  const storedTheme = getTheme();

  if (defaultTheme.endsWith(':only')) {
    applyTheme(defaultTheme.replace(':only', ''));
  } else if (storedTheme) {
    applyTheme(storedTheme);
  } else {
    applyTheme(defaultTheme === 'system' ? 'system' : defaultTheme);
  }

  // Button Click Handler
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('#theme-toggle');
    if (!btn) return;

    const current = getTheme();
    const next = THEME_ORDER[(THEME_ORDER.indexOf(current) + 1) % THEME_ORDER.length];

    localStorage.setItem('theme', next);
    applyTheme(next);
  });

  // System Theme Ã„nderungen beobachten
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
    if ((getTheme() ?? 'system') === 'system') {
      applyTheme('system');
    }
  });
</script>