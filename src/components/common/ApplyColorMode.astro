---
import { UI } from 'astrowind:config';
---

<script is:inline define:vars={{ defaultTheme: UI.theme || 'system' }}>
  function applyTheme(theme) {
    const root = document.documentElement;
    root.classList.remove('dark');

    if (theme === 'dark') {
      root.classList.add('dark');
    } else if (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      root.classList.add('dark');
    }

    // Update all toggle buttons
    const buttons = document.querySelectorAll('[data-aw-toggle-color-scheme]');
    buttons.forEach((btn) => {
      const icon = btn.querySelector('svg');
      if (!icon) return;

      if (theme === 'light') btn.dataset.iconName = 'tabler:sun';
      else if (theme === 'dark') btn.dataset.iconName = 'tabler:moon';
      else btn.dataset.iconName = 'tabler:device-desktop';

      // Re-render the icon
      if (window.Iconify) {
        window.Iconify.scan(btn);
      }
    });
  }

  const storedTheme = localStorage.getItem('theme');

  if (defaultTheme.endsWith(':only')) {
    applyTheme(defaultTheme.replace(':only', ''));
  } else if (storedTheme) {
    applyTheme(storedTheme);
  } else {
    applyTheme(defaultTheme);
  }

  // React to system theme changes
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
    if ((localStorage.getItem('theme') ?? 'system') === 'system') {
      applyTheme('system');
    }
  });
</script>