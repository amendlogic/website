---
import { UI } from 'astrowind:config';
---
<script is:inline define:vars={{ defaultTheme: UI.theme || 'system' }}>
  if (window.__awThemeInit) return;
  window.__awThemeInit = true;

  const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');

  function systemTheme() {
    return mediaQuery.matches ? 'dark' : 'light';
  }

  function applyTheme(theme) {
    document.documentElement.classList.toggle('dark', theme === 'dark');
  }

  function currentTheme() {
    return document.documentElement.classList.contains('dark')
      ? 'dark'
      : 'light';
  }

  // INITIAL
  const override = sessionStorage.getItem('themeOverride');
  applyTheme(override || systemTheme());

  // SYSTEM CHANGE â†’ RESET OVERRIDE
  mediaQuery.addEventListener('change', (e) => {
    sessionStorage.removeItem('themeOverride');
    applyTheme(e.matches ? 'dark' : 'light');
  });

  // TOGGLE HANDLER (event delegation)
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('[data-aw-toggle-color-scheme]');
    if (!btn) return;

    const next = currentTheme() === 'dark' ? 'light' : 'dark';
    sessionStorage.setItem('themeOverride', next);
    applyTheme(next);
  });
</script>
