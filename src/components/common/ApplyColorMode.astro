---
import { UI } from 'astrowind:config';
---

<script is:inline define:vars={{ defaultTheme: UI.theme || 'system' }}>
  function applyTheme(theme) {
    const root = document.documentElement;
    root.classList.remove('dark');

    if (theme === 'dark') root.classList.add('dark');
    else if (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      root.classList.add('dark');
    }

    const buttons = document.querySelectorAll('[data-aw-toggle-color-scheme]');
    buttons.forEach((btn) => {
      const iconName = theme === 'light' ? 'tabler:sun' : theme === 'dark' ? 'tabler:moon' : 'tabler:device-desktop';
      btn.dataset.iconName = iconName;

      const icon = btn.querySelector('svg');
      if (icon && window.Iconify) {
        window.Iconify.scan(btn);
      }
    });
  }

  const storedTheme = localStorage.getItem('theme');

  if (defaultTheme.endsWith(':only')) {
    applyTheme(defaultTheme.replace(':only', ''));
  } else if (storedTheme) {
    applyTheme(storedTheme);
  } else {
    applyTheme(defaultTheme);
  }

  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
    if ((localStorage.getItem('theme') ?? 'system') === 'system') {
      applyTheme('system');
    }
  });

  // Make it globally available
  window.applyTheme = applyTheme;
</script>