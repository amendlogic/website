---
import { UI } from 'astrowind:config';
---

<script is:inline define:vars={{ defaultTheme: UI.theme || 'system' }}>
  if (window.basic_script) return;
  window.basic_script = true;

  // --- 1. THEME LOGIK (3-State) ---
  function applyTheme(theme) {
    const resolvedTheme = (theme === 'system') 
      ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') 
      : theme;

    document.documentElement.classList.toggle('dark', resolvedTheme === 'dark');
    
    const icons = document.querySelectorAll('[data-aw-theme-icon]');
    icons.forEach((icon) => {
      icon.classList.toggle('hidden', icon.getAttribute('data-aw-theme-icon') !== theme);
    });
    
    if (window.Observer && typeof window.Observer.removeAnimationDelay === 'function') {
      window.Observer.removeAnimationDelay();
    }
  }

  const initTheme = () => {
    if (defaultTheme && defaultTheme.endsWith(':only')) {
      return applyTheme(defaultTheme.replace(':only', ''));
    }
    applyTheme(localStorage.getItem('theme') || 'system');
  };

  // --- 2. HELPER & PERFORMANCE ---
  function attachEvent(selector, event, fn) {
    const matches = typeof selector === 'string' ? document.querySelectorAll(selector) : selector;
    if (matches && matches.length) {
      matches.forEach((elem) => elem.addEventListener(event, (e) => fn(e, elem), false));
    }
  }

  // Debounce für flüssiges Resizen
  function debounce(func, wait) {
    let timeout;
    return function(...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), wait);
    };
  }

  // --- 3. HAUPTFUNKTIONEN ---
  const setup = () => {
    const header = document.getElementById('header');

    // Hamburger Menü
    attachEvent('[data-aw-toggle-menu]', 'click', function (_, elem) {
      elem.classList.toggle('expanded');
      document.body.classList.toggle('overflow-hidden');
      header?.classList.toggle('h-screen');
      header?.classList.toggle('expanded');
      header?.classList.toggle('bg-page');
      document.querySelector('#header nav')?.classList.toggle('hidden');
      document.querySelector('#header > div > div:last-child')?.classList.toggle('hidden');
    });

    // Theme Toggle (Rotation)
    attachEvent('[data-aw-toggle-color-scheme]', 'click', function () {
      if (defaultTheme.endsWith(':only')) return;
      const themes = ['system', 'light', 'dark'];
      const currentTheme = localStorage.getItem('theme') || 'system';
      const nextTheme = themes[(themes.indexOf(currentTheme) + 1) % 3];

      localStorage.setItem('theme', nextTheme);
      applyTheme(nextTheme);
    });

    // Social Share
    attachEvent('[data-aw-social-share]', 'click', function (_, elem) {
      const network = elem.getAttribute('data-aw-social-share');
      const url = encodeURIComponent(elem.getAttribute('data-aw-url') || window.location.href);
      const text = encodeURIComponent(elem.getAttribute('data-aw-text') || '');
      const links = {
        facebook: `https://www.facebook.com/sharer.php?u=${url}`,
        twitter: `https://twitter.com/intent/tweet?url=${url}&text=${text}`,
        linkedin: `https://www.linkedin.com/shareArticle?mini=true&url=${url}&title=${text}`,
        whatsapp: `https://wa.me/?text=${text}%20${url}`,
        mail: `mailto:?subject=${text}&body=${url}`
      };
      if (links[network]) window.open(links[network], '_blank');
    });

    // Sticky Header mit Debounce für Performance
    const applyHeaderStylesOnScroll = () => {
      const stickyHeader = document.querySelector('#header[data-aw-sticky-header]');
      if (stickyHeader) {
        window.scrollY > 60 ? stickyHeader.classList.add('scroll') : stickyHeader.classList.remove('scroll');
      }
    };

    window.addEventListener('scroll', debounce(applyHeaderStylesOnScroll, 10));
    applyHeaderStylesOnScroll();
  };

  // --- 4. LIFECYCLE ---
  const onPageLoad = () => {
    initTheme();
    setup();
    if (window.Observer) window.Observer.start();
  };

  window.onload = onPageLoad;
  document.addEventListener('astro:after-swap', onPageLoad);

  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
    if (localStorage.getItem('theme') === 'system') applyTheme('system');
  });
</script>

<script is:inline>
  // --- 5. INTERSECTION OBSERVER (ANIMATIONEN) ---
  window.Observer = {
    observer: null,
    elements: [],
    animationCounter: 0,
    
    start() {
      // Nutze RequestIdleCallback, damit das Layout (Textgröße) Vorrang hat
      const init = () => {
        const selectors = ['[class*=" intersect:"]','[class*=":intersect:"]','[class^="intersect:"]','[class="intersect"]'];
        this.elements = Array.from(document.querySelectorAll(selectors.join(',')));
        
        this.observer = new IntersectionObserver((entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              const target = entry.target;
              if (!target.hasAttribute('data-animated')) {
                target.removeAttribute('no-intersect');
                target.setAttribute('data-animated', 'true');
                target.style.transitionDelay = `${this.animationCounter * 100}ms`;
                this.animationCounter++;
                if (target.classList.contains('intersect-once')) this.observer.unobserve(target);
              }
            } else if (!entry.target.classList.contains('intersect-once')) {
              entry.target.setAttribute('no-intersect', '');
              entry.target.removeAttribute('data-animated');
              this.animationCounter = 0;
            }
          });
        }, { threshold: [0, 0.25, 0.5] });

        this.elements.forEach((el) => {
          el.setAttribute('no-intersect', '');
          this.observer.observe(el);
        });
      };

      if (window.requestIdleCallback) {
        window.requestIdleCallback(init);
      } else {
        setTimeout(init, 100);
      }
    },
    
    removeAnimationDelay() {
      this.elements.forEach((el) => {
        el.style.transitionDelay = '0ms';
        el.style.animationDelay = '0ms';
      });
    }
  };
</script>
