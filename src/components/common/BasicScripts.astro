import { UI } from 'astrowind:config';
---

<script is:inline define:vars={{ defaultTheme: UI.theme || 'system' }}>
// Verhindert doppelte Ausführung bei initialem Laden
if (window.basic_script_init) return;
window.basic_script_init = true;

(function() {
  let cleanupFns = [];

  // Variablen deklarieren (wichtig für Scope), aber noch nicht befüllen
  let docEl, body, header, stickyHeader, menuBtn, nav;

  // --- DOM REFRESH (FIX FÜR VIEW TRANSITIONS) ---
  // Diese Funktion holt sich bei jedem Seitenwechsel die aktuellen Elemente
  const initDom = () => {
    docEl = document.documentElement;
    body = document.body;
    header = document.getElementById('header');
    stickyHeader = header?.querySelector('[data-aw-sticky-header]');
    menuBtn = header?.querySelector('[data-aw-toggle-menu]');
    nav = header?.querySelector('nav');
  };

  // --- HELPERS ---
  const toggleClass = (el, className, condition) => { if(el) el.classList.toggle(className, !!condition); };

  const applyTheme = (theme) => {
    const resolved = theme === 'system'
      ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light')
      : theme;

    // Sicherstellen, dass docEl existiert
    if (docEl) {
      docEl.dataset.theme = resolved;
      toggleClass(docEl, 'dark', resolved === 'dark');
    }

    // Icon Toggle
    if(menuBtn){
      const icons = menuBtn.querySelectorAll('svg,[data-aw-icon]');
      if(icons.length > 1){
        icons[0].classList.toggle('hidden', resolved === 'dark');
      }
    }
  };

  // --- HEADER SCROLL ---
  const initHeader = () => {
    if(!stickyHeader) return;
    
    // Status initial setzen
    let lastState = window.scrollY > 60;
    toggleClass(stickyHeader, 'scroll', lastState);

    const onScroll = () => {
      const isScrolled = window.scrollY > 60;
      if(isScrolled !== lastState){
        toggleClass(stickyHeader, 'scroll', isScrolled);
        lastState = isScrolled;
      }
    };

    window.addEventListener('scroll', onScroll, { passive: true });
    cleanupFns.push(() => window.removeEventListener('scroll', onScroll));
  };

  // --- MENU ---
  const initMenu = () => {
    if(!menuBtn || !nav) return;

    const toggleIcons = (isExpanded) => {
      const icons = menuBtn.querySelectorAll('svg,[data-aw-icon]');
      if(icons.length > 1){
        icons[0].classList.toggle('hidden', isExpanded);
        icons[1].classList.toggle('hidden', !isExpanded);
      }
    };

    const toggleMenu = () => {
      const isExpanded = menuBtn.classList.toggle('expanded');
      body.classList.toggle('overflow-hidden', isExpanded);
      
      if(header) {
        header.classList.toggle('h-screen', isExpanded);
        header.classList.toggle('expanded', isExpanded);
        header.classList.toggle('bg-page', isExpanded);
        
        const actions = header.querySelector('nav + div, div > div:last-child');
        if(actions) actions.classList.toggle('hidden', !isExpanded);
      }

      toggleIcons(isExpanded);
      nav.classList.toggle('hidden');
    };

    window.closeMenuInstance = () => { 
      if(menuBtn && menuBtn.classList.contains('expanded')) toggleMenu(); 
    };

    menuBtn.addEventListener('click', toggleMenu);
    cleanupFns.push(() => menuBtn.removeEventListener('click', toggleMenu));

    // Dropdown Event Delegation
    const onNavClick = (e) => {
      const trigger = e.target.closest('.dropdown > button, .dropdown > a');
      if(!trigger || window.getComputedStyle(menuBtn).display === 'none') return;

      e.preventDefault();
      const subMenu = trigger.nextElementSibling;
      if(subMenu){
        const expanded = subMenu.classList.toggle('hidden') === false;
        trigger.classList.toggle('expanded', expanded);
        trigger.setAttribute('aria-expanded', expanded);
      }
    };
    
    nav.addEventListener('click', onNavClick);
    cleanupFns.push(() => nav.removeEventListener('click', onNavClick));
  };

  // --- GLOBAL EVENTS (LINKS & SMOOTH SCROLL) ---
  const initGlobalEvents = () => {
    const onClick = (e) => {
      // Theme Toggle
      const themeBtn = e.target.closest('[data-aw-toggle-color-scheme]');
      if(themeBtn){
        const themes = ['system','light','dark'];
        const current = localStorage.getItem('theme') || 'system';
        const next = themes[(themes.indexOf(current) + 1) % 3];
        localStorage.setItem('theme', next);
        applyTheme(next);
        return;
      }

      // Smooth Scroll
      const link = e.target.closest('a');
      if(!link || !link.hash || link.origin !== location.origin || link.pathname !== location.pathname) return;

      const targetEl = document.querySelector(link.hash);
      if(!targetEl) return;

      e.preventDefault();
      link.blur();

      // Menü schließen falls offen
      if(header?.classList.contains('expanded') && window.closeMenuInstance){
        window.closeMenuInstance();
      }

      // Short delay, damit Mobile Browser Layout stabil ist
      setTimeout(() => {
        const headerHeight = header?.getBoundingClientRect().height || 0;
        const targetPos = targetEl.getBoundingClientRect().top + window.scrollY;

        window.scrollTo({ top: targetPos - headerHeight, behavior: 'smooth' });
        history.pushState(null, null, link.hash);
      }, 50);
    };

    document.addEventListener('click', onClick, { capture: true, passive: false });
    cleanupFns.push(() => document.removeEventListener('click', onClick, { capture: true }));
  };

  // --- ANIMATIONS (INTERSECTION OBSERVER) ---
  const initAnimations = () => {
    const selectors = ['[class*=" intersect:"]','[class*=":intersect:"]','[class^="intersect:"]','[class="intersect"]','.intersect-once','.intersect-quarter'];
    const elements = document.querySelectorAll(selectors.join(','));
    if(!elements.length) return;

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if(entry.isIntersecting){
          const el = entry.target;
          el.setAttribute('data-aw-animated', 'true');
          el.removeAttribute('no-intersect');
          if(el.classList.contains('intersect-once')) observer.unobserve(el);
        }
      });
    }, { threshold: 0.1, rootMargin: '0px 0px -10% 0px' });

    elements.forEach(el => {
      el.setAttribute('no-intersect', '');
      observer.observe(el);
    });

    cleanupFns.push(() => observer.disconnect());
  };

  // --- MAIN RUN ---
  const run = () => {
    // 1. Alte Listener aufräumen
    cleanupFns.forEach(fn => fn());
    cleanupFns = [];

    // 2. DOM-Elemente neu initialisieren (Kritisch für Astro View Transitions!)
    initDom();

    // 3. Logik starten
    applyTheme(localStorage.getItem('theme') || defaultTheme);
    initHeader();
    initMenu();
    
    // Globale Events leicht verzögern
    setTimeout(initGlobalEvents, 0);

    // Animationen performant starten
    if(window.requestIdleCallback) window.requestIdleCallback(initAnimations);
    else setTimeout(initAnimations, 200);
  };

  // Start beim ersten Laden
  run();

  // Neustart bei Astro View Transitions
  document.addEventListener('astro:after-swap', run);

  // CSS Smooth Scroll global aktivieren
  if (document.documentElement) {
    document.documentElement.classList.add('motion-safe:scroll-smooth');
  }
})();
</script>
