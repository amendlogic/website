---
import { UI } from 'astrowind:config';
---

<script is:inline define:vars={{ defaultTheme: UI.theme || 'system' }}>
  // Verhindert mehrfache Initialisierung
  if (window.basic_script) return;
  window.basic_script = true;

  // --- THEME LOGIK ---
  function applyTheme(theme) {
    const resolvedTheme = (theme === 'system') 
      ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') 
      : theme;

    document.documentElement.classList.toggle('dark', resolvedTheme === 'dark');
    
    const icons = document.querySelectorAll('[data-aw-theme-icon]');
    icons.forEach((icon) => {
      icon.classList.toggle('hidden', icon.getAttribute('data-aw-theme-icon') !== theme);
    });
    
    // Fix f端r flackernde Animationen beim Theme-Wechsel
    if (window.Observer && typeof window.Observer.removeAnimationDelay === 'function') {
      window.Observer.removeAnimationDelay();
    }
  }

  const initTheme = function () {
    if (defaultTheme && defaultTheme.endsWith(':only')) {
      return applyTheme(defaultTheme.replace(':only', ''));
    }
    applyTheme(localStorage.getItem('theme') || 'system');
  };

  // --- HELPER ---
  function attachEvent(selector, event, fn) {
    const matches = typeof selector === 'string' ? document.querySelectorAll(selector) : selector;
    if (matches && matches.length) {
      matches.forEach((elem) => elem.addEventListener(event, (e) => fn(e, elem), false));
    }
  }

  const setup = function () {
    const header = document.getElementById('header');
    
    // Men端-Logik (Robust f端r Mobile)
    attachEvent('[data-aw-toggle-menu]', 'click', function (_, elem) {
      elem.classList.toggle('expanded');
      document.body.classList.toggle('overflow-hidden');
      header?.classList.toggle('h-screen');
      header?.classList.toggle('expanded');
      header?.classList.toggle('bg-page');
      document.querySelector('#header nav')?.classList.toggle('hidden');
      document.querySelector('#header > div > div:last-child')?.classList.toggle('hidden');
    });

    // 3-State Toggle Rotation
    attachEvent('[data-aw-toggle-color-scheme]', 'click', function () {
      if (defaultTheme.endsWith(':only')) return;
      const themes = ['system', 'light', 'dark'];
      const currentTheme = localStorage.getItem('theme') || 'system';
      const nextTheme = themes[(themes.indexOf(currentTheme) + 1) % 3];

      localStorage.setItem('theme', nextTheme);
      applyTheme(nextTheme);
    });

    // Social Share
    attachEvent('[data-aw-social-share]', 'click', function (_, elem) {
      const network = elem.getAttribute('data-aw-social-share');
      const url = encodeURIComponent(elem.getAttribute('data-aw-url') || window.location.href);
      const text = encodeURIComponent(elem.getAttribute('data-aw-text') || '');
      
      const shareLinks = {
        facebook: `https://www.facebook.com/sharer.php?u=${url}`,
        twitter: `https://twitter.com/intent/tweet?url=${url}&text=${text}`,
        linkedin: `https://www.linkedin.com/shareArticle?mini=true&url=${url}&title=${text}`,
        whatsapp: `https://wa.me/?text=${text}%20${url}`,
        mail: `mailto:?subject=${text}&body=${url}`
      };
      
      if (shareLinks[network]) window.open(shareLinks[network], '_blank');
    });

    // Sticky Header Scroll
    const applyHeaderStylesOnScroll = () => {
      const stickyHeader = document.querySelector('#header[data-aw-sticky-header]');
      if (stickyHeader) {
        window.scrollY > 60 ? stickyHeader.classList.add('scroll') : stickyHeader.classList.remove('scroll');
      }
    };
    window.addEventListener('scroll', applyHeaderStylesOnScroll);
    applyHeaderStylesOnScroll();
  };

  // --- INITIALISIERUNG ---
  const onPageLoad = () => {
    initTheme();
    setup();
    if (window.Observer) window.Observer.start();
  };

  window.onload = onPageLoad;
  document.addEventListener('astro:after-swap', onPageLoad);

  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
    if (localStorage.getItem('theme') === 'system') applyTheme('system');
  });
</script>

<script is:inline>
  // Globaler Observer f端r Intersect-Animationen
  window.Observer = {
    observer: null,
    elements: [],
    animationCounter: 0,
    
    start() {
      const selectors = ['[class*=" intersect:"]','[class*=":intersect:"]','[class^="intersect:"]','[class="intersect"]'];
      this.elements = Array.from(document.querySelectorAll(selectors.join(',')));
      
      this.observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const target = entry.target;
            if (!target.hasAttribute('data-animated')) {
              target.removeAttribute('no-intersect');
              target.setAttribute('data-animated', 'true');
              const delay = this.animationCounter * 100;
              target.style.transitionDelay = `${delay}ms`;
              this.animationCounter++;
              if (target.classList.contains('intersect-once')) this.observer.unobserve(target);
            }
          } else if (!entry.target.classList.contains('intersect-once')) {
            entry.target.setAttribute('no-intersect', '');
            entry.target.removeAttribute('data-animated');
            this.animationCounter = 0;
          }
        });
      }, { threshold: [0, 0.25, 0.5, 0.99] });

      this.elements.forEach((el) => {
        el.setAttribute('no-intersect', '');
        this.observer.observe(el);
      });
    },
    
    removeAnimationDelay() {
      this.elements.forEach((el) => {
        el.style.transitionDelay = '0ms';
        el.style.animationDelay = '0ms';
      });
    }
  };
</script>
