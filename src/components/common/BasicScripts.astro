---
import { UI } from 'astrowind:config';
---

<script is:inline define:vars={{ defaultTheme: UI.theme || 'system' }}>
  if (window.basic_script) return;
  window.basic_script = true;

  // --- 1. PERFORMANCE HELPERS ---
  
  // Throttle: Garantiert Ausführung alle X ms (Perfekt für Scroll/Header)
  const throttle = (fn, limit) => {
    let inThrottle;
    return (...args) => {
      if (!inThrottle) {
        fn(...args);
        inThrottle = true;
        setTimeout(() => (inThrottle = false), limit);
      }
    };
  };

  // Debounce: Wartet bis die Aktion stoppt (Perfekt für Resize/Suche)
  const debounce = (fn, delay) => {
    let timeout;
    return (...args) => {
      clearTimeout(timeout);
      timeout = setTimeout(() => fn(...args), delay);
    };
  };

  // --- 2. THEME LOGIK (3-State) ---
  function applyTheme(theme) {
    const resolvedTheme = (theme === 'system') 
      ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') 
      : theme;

    document.documentElement.classList.toggle('dark', resolvedTheme === 'dark');
    
    document.querySelectorAll('[data-aw-theme-icon]').forEach((icon) => {
      icon.classList.toggle('hidden', icon.getAttribute('data-aw-theme-icon') !== theme);
    });
    
    window.Observer?.removeAnimationDelay();
  }

  // --- 3. CORE SETUP ---
  const setup = () => {
    const header = document.getElementById('header');
    const stickyHeader = document.querySelector('#header[data-aw-sticky-header]');

    // Schnelle Header-Scroll-Logik
    const checkHeader = () => {
      if (stickyHeader) {
        if (window.scrollY > 10) {
          stickyHeader.classList.add('scroll');
        } else {
          stickyHeader.classList.remove('scroll');
        }
      }
    };

    // Throttle auf 10ms für Echtzeit-Gefühl beim Scrollen
    window.addEventListener('scroll', throttle(checkHeader, 10));
    checkHeader();

    // Hamburger Menü Toggle
    const toggleMenu = () => {
      const menuBtn = document.querySelector('[data-aw-toggle-menu]');
      if (!menuBtn) return;
      menuBtn.classList.toggle('expanded');
      document.body.classList.toggle('overflow-hidden');
      header?.classList.toggle('h-screen');
      header?.classList.toggle('expanded');
      header?.classList.toggle('bg-page');
      document.querySelector('#header nav')?.classList.toggle('hidden');
      document.querySelector('#header > div > div:last-child')?.classList.toggle('hidden');
    };

    document.querySelectorAll('[data-aw-toggle-menu]').forEach(el => {
      el.onclick = toggleMenu;
    });

    // Theme-Toggle Rotation
    const toggleTheme = () => {
      if (defaultTheme.endsWith(':only')) return;
      const themes = ['system', 'light', 'dark'];
      const current = localStorage.getItem('theme') || 'system';
      const next = themes[(themes.indexOf(current) + 1) % 3];
      localStorage.setItem('theme', next);
      applyTheme(next);
    };

    document.querySelectorAll('[data-aw-toggle-color-scheme]').forEach(el => {
      el.onclick = toggleTheme;
    });

    // Social Share
    const handleShare = (elem) => {
      const network = elem.getAttribute('data-aw-social-share');
      const url = encodeURIComponent(elem.getAttribute('data-aw-url') || window.location.href);
      const text = encodeURIComponent(elem.getAttribute('data-aw-text') || '');
      const links = {
        facebook: `https://www.facebook.com/sharer.php?u=${url}`,
        twitter: `https://twitter.com/intent/tweet?url=${url}&text=${text}`,
        linkedin: `https://www.linkedin.com/shareArticle?mini=true&url=${url}&title=${text}`,
        whatsapp: `https://wa.me/?text=${text}%20${url}`,
        mail: `mailto:?subject=${text}&body=${url}`
      };
      if (links[network]) window.open(links[network], '_blank');
    };

    document.querySelectorAll('[data-aw-social-share]').forEach(el => {
      el.onclick = () => handleShare(el);
    });
  };

  // --- 4. LIFECYCLE ---
  const onPageLoad = () => {
    applyTheme(localStorage.getItem('theme') || 'system');
    setup();
    window.Observer?.start();
  };

  window.onload = onPageLoad;
  document.addEventListener('astro:after-swap', onPageLoad);

  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
    if (localStorage.getItem('theme') === 'system') applyTheme('system');
  });
</script>

<script is:inline>
  // --- 5. OPTIMIERTER INTERSECTION OBSERVER ---
  window.Observer = {
    observer: null,
    start() {
      const init = () => {
        const els = Array.from(document.querySelectorAll('[class*="intersect"]'));
        if (!els.length) return;

        this.observer = new IntersectionObserver((entries) => {
          entries.forEach((entry) => {
            const target = entry.target;
            if (entry.isIntersecting) {
              if (!target.hasAttribute('data-animated')) {
                target.removeAttribute('no-intersect');
                target.setAttribute('data-animated', 'true');
                if (target.classList.contains('intersect-once')) this.observer.unobserve(target);
              }
            } else if (!target.classList.contains('intersect-once')) {
              target.setAttribute('no-intersect', '');
              target.removeAttribute('data-animated');
            }
          });
        }, { threshold: 0.1 });

        els.forEach(el => this.observer.observe(el));
      };

      // Nutzt Leerlaufzeit für Animationen, damit Text/Layout Vorrang haben
      (window.requestIdleCallback || ((cb) => setTimeout(cb, 100)))(init);
    },
    removeAnimationDelay() {
      document.querySelectorAll('[data-animated]').forEach(el => {
        el.style.transitionDelay = '0ms';
        el.style.animationDelay = '0ms';
      });
    }
  };
</script>
