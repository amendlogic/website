---
import { UI } from 'astrowind:config';
---

<script is:inline define:vars={{ defaultTheme: UI.theme || 'system' }}>
  if (window.basic_script_init) return;
  window.basic_script_init = true;

  (function() {
    let cleanupFns = [];

    // --- 1. THEME & HEADER HELPERS ---
    const getHeaderHeight = () => {
      const header = document.getElementById('header');
      return header ? header.getBoundingClientRect().height : 0;
    };

    const applyTheme = (theme) => {
      const resolvedTheme = (theme === 'system') 
        ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') 
        : theme;
      document.documentElement.classList.toggle('dark', resolvedTheme === 'dark');
      document.querySelectorAll('[data-aw-theme-icon]').forEach((icon) => {
         icon.classList.toggle('hidden', icon.getAttribute('data-aw-theme-icon') !== theme);
      });
    };

    // --- 2. DIE "NUCLEAR" CLOSE FUNKTION ---
    // Diese Funktion setzt ALLES zurück. Kompromisslos.
    const closeEverything = () => {
        // A. Alle Dropdowns schließen
        document.querySelectorAll('.dropdown > .expanded').forEach(el => {
            el.classList.remove('expanded');
            if (el.nextElementSibling) el.nextElementSibling.classList.add('hidden');
        });

        // B. Mobile Menu schließen
        const menuBtn = document.querySelector('[data-aw-toggle-menu]');
        if (menuBtn && menuBtn.classList.contains('expanded')) {
            menuBtn.classList.remove('expanded');
            document.body.classList.remove('overflow-hidden');
            const header = document.getElementById('header');
            if (header) {
                header.classList.remove('h-screen', 'expanded', 'bg-page');
                header.querySelector('nav')?.classList.add('hidden');
                header.querySelector('div > div:last-child')?.classList.add('hidden');
            }
        }
    };

    // --- 3. EVENT HANDLER ---
    const initGlobalListener = () => {
      const handleGlobalClick = (e) => {
        const target = e.target;

        // --- FALL A: THEME TOGGLE ---
        if (target.closest('[data-aw-toggle-color-scheme]')) {
            e.preventDefault();
            const themes = ['system', 'light', 'dark'];
            const current = localStorage.getItem('theme') || 'system';
            const next = themes[(themes.indexOf(current) + 1) % 3];
            localStorage.setItem('theme', next);
            applyTheme(next);
            return;
        }

        // --- FALL B: MOBILE MENU TOGGLE (HAMBURGER) ---
        const menuBtn = target.closest('[data-aw-toggle-menu]');
        if (menuBtn) {
            e.stopPropagation(); // Verhindert Konflikte
            
            // Toggle Logic
            const isExpanded = menuBtn.classList.contains('expanded');
            
            // Wenn wir es schließen, rufen wir einfach closeEverything auf
            if (isExpanded) {
                closeEverything();
            } else {
                // Öffnen
                menuBtn.classList.add('expanded');
                document.body.classList.add('overflow-hidden');
                const header = document.getElementById('header');
                if (header) {
                    header.classList.add('h-screen', 'expanded', 'bg-page');
                    header.querySelector('nav')?.classList.remove('hidden');
                    header.querySelector('div > div:last-child')?.classList.remove('hidden');
                }
            }
            return;
        }

        // --- FALL C: DROPDOWN TRIGGER (TITEL) ---
        // Das sind die Buttons/Links, die das Untermenü öffnen
        const dropdownTrigger = target.closest('.dropdown > button, .dropdown > a');
        // Wichtig: Wir müssen unterscheiden, ob es ein reiner Trigger ist oder ein echter Link.
        // In AstroWind sind Trigger oft Links mit href="#" oder javascript:void(0) oder Buttons.
        // Wenn es ein echter Link mit Hash ist, fällt er in Fall D.
        if (dropdownTrigger && (!dropdownTrigger.hash || dropdownTrigger.hash === '#')) {
            e.preventDefault();
            e.stopPropagation();

            const wasOpen = dropdownTrigger.classList.contains('expanded');
            
            // Strategie: Erstmal ALLE anderen Dropdowns schließen
            document.querySelectorAll('.dropdown > .expanded').forEach(el => {
                if (el !== dropdownTrigger) { // Uns selbst nicht schließen, das machen wir gleich logisch
                    el.classList.remove('expanded');
                    if (el.nextElementSibling) el.nextElementSibling.classList.add('hidden');
                }
            });

            // Jetzt uns selbst toggeln
            if (wasOpen) {
                dropdownTrigger.classList.remove('expanded');
                if(dropdownTrigger.nextElementSibling) dropdownTrigger.nextElementSibling.classList.add('hidden');
            } else {
                dropdownTrigger.classList.add('expanded');
                if(dropdownTrigger.nextElementSibling) dropdownTrigger.nextElementSibling.classList.remove('hidden');
            }
            return;
        }

        // --- FALL D: ECHTE LINKS (NAVIGATION) ---
        // Das hier ist der wichtigste Teil für dich!
        const link = target.closest('a');
        if (link) {
            // 1. SOFORT ALLES SCHLIEßEN
            closeEverything();

            // 2. Smooth Scroll Logik für #hashes
            if (link.hash && link.origin === window.location.origin && link.pathname === window.location.pathname) {
                const el = document.querySelector(link.hash);
                if (el) {
                    e.preventDefault();
                    // Kleines Timeout, damit das Schließen des Menüs (Layout Shift) berechnet ist
                    setTimeout(() => {
                        const headerHeight = getHeaderHeight();
                        const targetPos = el.getBoundingClientRect().top + window.scrollY;
                        window.scrollTo({ top: targetPos - headerHeight, behavior: 'smooth' });
                        history.pushState(null, null, link.hash);
                    }, 10);
                }
            }
            return;
        }

        // --- FALL E: KLICK DANEBEN (OUTSIDE CLICK) ---
        // Wenn wir nicht ins Nav und nicht auf den Button geklickt haben -> Zu machen.
        if (!target.closest('#header nav') && !target.closest('[data-aw-toggle-menu]')) {
            closeEverything();
        }
      };

      // Wir nutzen 'click' auf document. 
      document.addEventListener('click', handleGlobalClick, { capture: true });
      cleanupFns.push(() => document.removeEventListener('click', handleGlobalClick, { capture: true }));
    };

    // --- 4. SCROLL STATE (HEADER) ---
    const initHeaderScroll = () => {
        const header = document.querySelector('#header[data-aw-sticky-header]');
        if(!header) return;
        const onScroll = () => {
             header.classList.toggle('scroll', window.scrollY > 10);
        };
        window.addEventListener('scroll', onScroll, { passive: true });
        if(window.scrollY > 10) header.classList.add('scroll');
        cleanupFns.push(() => window.removeEventListener('scroll', onScroll));
    };

    // --- 5. INITIALISIERUNG & RELOAD FIX ---
    const run = () => {
        cleanupFns.forEach(fn => fn()); 
        cleanupFns = [];

        applyTheme(localStorage.getItem('theme') || defaultTheme);
        initHeaderScroll();
        initGlobalListener();

        // Fix: Beim Laden an die richtige Stelle springen
        if (window.location.hash) {
            const target = document.querySelector(window.location.hash);
            if (target) {
                setTimeout(() => {
                    const headerHeight = getHeaderHeight();
                    const targetPos = target.getBoundingClientRect().top + window.scrollY;
                    window.scrollTo({ top: targetPos - headerHeight, behavior: 'instant' });
                }, 100); 
            }
        }
    };

    run();
    document.addEventListener('astro:after-swap', run);
  })();
</script>
