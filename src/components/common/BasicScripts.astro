<script is:inline define:vars={{ defaultTheme: UI.theme }}>
  if (window.__aw_initialized) return;
  window.__aw_initialized = true;

  /* ===============================
     THEME
  =============================== */
  function applyTheme(theme) {
    document.documentElement.classList.toggle('dark', theme === 'dark');
  }

  function initTheme() {
    if (
      (defaultTheme && defaultTheme.endsWith(':only')) ||
      (!localStorage.theme && defaultTheme !== 'system')
    ) {
      applyTheme(defaultTheme.replace(':only', ''));
    } else if (
      localStorage.theme === 'dark' ||
      (!('theme' in localStorage) &&
        window.matchMedia('(prefers-color-scheme: dark)').matches)
    ) {
      applyTheme('dark');
    } else {
      applyTheme('light');
    }
  }

  initTheme();

  /* ===============================
     HELPERS
  =============================== */
  function attach(selector, event, fn) {
    const nodes =
      typeof selector === 'string'
        ? document.querySelectorAll(selector)
        : selector;
    nodes?.forEach((el) => el.addEventListener(event, fn, false));
  }

  function resetIntersectState() {
    document.querySelectorAll('[no-intersect]').forEach((el) => {
      el.removeAttribute('no-intersect');
      el.removeAttribute('data-animated');
      el.style.opacity = '';
      el.style.transform = '';
      el.style.transitionDelay = '';
      el.style.animationDelay = '';
    });
  }

  function resizeCharts() {
    if (window.__echarts_instances) {
      window.__echarts_instances.forEach((chart) => {
        try {
          chart.resize();
        } catch (e) {}
      });
    }
  }

  function restoreUIState() {
    resetIntersectState();
    resizeCharts();
  }

  /* ===============================
     HEADER / NAV
  =============================== */
  function initHeader() {
    attach('[data-aw-toggle-menu]', 'click', (e) => {
      const header = document.getElementById('header');
      document.body.classList.toggle('overflow-hidden');
      header?.classList.toggle('expanded');
      header?.classList.toggle('h-screen');
      header?.classList.toggle('bg-page');
      document.querySelector('#header nav')?.classList.toggle('hidden');
    });

    attach('[data-aw-toggle-color-scheme]', 'click', () => {
      if (defaultTheme.endsWith(':only')) return;
      document.documentElement.classList.toggle('dark');
      localStorage.theme = document.documentElement.classList.contains('dark')
        ? 'dark'
        : 'light';
    });
  }

  /* ===============================
     INTERSECTION OBSERVER (SAFE)
  =============================== */
  const Observer = {
    observer: null,
    start() {
      if (this.observer) this.observer.disconnect();

      const elements = document.querySelectorAll(
        '[class*="intersect"]'
      );

      this.observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            const el = entry.target;

            if (entry.isIntersecting) {
              el.removeAttribute('no-intersect');
              el.setAttribute('data-animated', 'true');

              if (el.classList.contains('intersect-once')) {
                this.observer.unobserve(el);
              }
            } else if (!el.classList.contains('intersect-once')) {
              el.setAttribute('no-intersect', '');
              el.removeAttribute('data-animated');
            }
          });
        },
        { threshold: 0.15 }
      );

      elements.forEach((el) => {
        el.setAttribute('no-intersect', '');
        this.observer.observe(el);
      });
    },
  };

  /* ===============================
     LIFECYCLE EVENTS
  =============================== */
  window.addEventListener('pageshow', restoreUIState);
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden) {
      requestAnimationFrame(restoreUIState);
    }
  });

  document.addEventListener('astro:after-swap', () => {
    initTheme();
    initHeader();
    Observer.start();
    restoreUIState();
  });

  window.addEventListener('load', () => {
    initHeader();
    Observer.start();
    restoreUIState();
  });
</script>
