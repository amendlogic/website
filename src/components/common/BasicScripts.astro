---
import { UI } from 'astrowind:config';
---

<script is:inline define:vars={{ defaultTheme: UI.theme || 'system' }}>
  if (window.basic_script_init) return;
  window.basic_script_init = true;

  (function() {
    let cleanupFns = [];

    // --- HELPER: HEADER HEIGHT ---
    const getHeaderHeight = () => {
      const header = document.getElementById('header');
      return header ? header.getBoundingClientRect().height : 0;
    };

    // --- 1. RESET FUNCTION (CLOSE ALL) ---
    // Schließt kompromisslos alle Menüs und Dropdowns
    const resetMenu = () => {
        // A. Mobile Hamburger Button resetten
        const menuBtn = document.querySelector('[data-aw-toggle-menu]');
        if (menuBtn) menuBtn.classList.remove('expanded');
        
        // B. Mobile Container verstecken
        document.body.classList.remove('overflow-hidden');
        const header = document.getElementById('header');
        if (header) {
            header.classList.remove('h-screen', 'expanded', 'bg-page');
            header.querySelector('nav')?.classList.add('hidden');
            header.querySelector('div > div:last-child')?.classList.add('hidden');
        }

        // C. ALLE Dropdown Buttons zurücksetzen (Desktop & Mobile)
        // Wir suchen spezifisch nach Buttons, die expanded sind
        document.querySelectorAll('.dropdown > button.expanded').forEach(btn => {
            btn.classList.remove('expanded');
            // Das Element danach (das eigentliche Dropdown-Menü) verstecken
            if (btn.nextElementSibling) {
                btn.nextElementSibling.classList.add('hidden');
            }
        });
    };

    // --- 2. THEME LOGIC ---
    const applyTheme = (theme) => {
      const resolvedTheme = (theme === 'system') 
        ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') 
        : theme;
      
      requestAnimationFrame(() => {
        document.documentElement.classList.toggle('dark', resolvedTheme === 'dark');
        document.querySelectorAll('[data-aw-theme-icon]').forEach((icon) => {
          icon.classList.toggle('hidden', icon.getAttribute('data-aw-theme-icon') !== theme);
        });
      });
    };

    // --- 3. CENTRAL EVENT LISTENER ---
    const initGlobalListener = () => {
      
      const handleGlobalClick = (e) => {
        const target = e.target;

        // --- A) THEME TOGGLE ---
        if (target.closest('[data-aw-toggle-color-scheme]')) {
            e.preventDefault();
            const themes = ['system', 'light', 'dark'];
            const current = localStorage.getItem('theme') || 'system';
            const next = themes[(themes.indexOf(current) + 1) % 3];
            localStorage.setItem('theme', next);
            applyTheme(next);
            return;
        }

        // --- B) HAMBURGER TOGGLE ---
        const menuBtn = target.closest('[data-aw-toggle-menu]');
        if (menuBtn) {
            e.stopPropagation();
            if (menuBtn.classList.contains('expanded')) {
                resetMenu(); // Klick auf offenen Hamburger -> Schließen
            } else {
                // Öffnen
                menuBtn.classList.add('expanded');
                document.body.classList.add('overflow-hidden');
                const header = document.getElementById('header');
                header.classList.add('h-screen', 'expanded', 'bg-page');
                header.querySelector('nav')?.classList.remove('hidden');
                header.querySelector('div > div:last-child')?.classList.remove('hidden');
            }
            return;
        }

        // --- C) DROPDOWN BUTTON (TOGGLE) ---
        // Das ist die Änderung: Wir reagieren nur auf <button> innerhalb von .dropdown
        const dropdownBtn = target.closest('.dropdown > button');
        if (dropdownBtn) {
            e.preventDefault();
            e.stopPropagation(); // Klick bleibt hier, geht nicht ans Document

            const wasOpen = dropdownBtn.classList.contains('expanded');

            // 1. Alle ANDEREN Dropdowns schließen (Accordion-Verhalten)
            document.querySelectorAll('.dropdown > button.expanded').forEach(btn => {
                if (btn !== dropdownBtn) {
                    btn.classList.remove('expanded');
                    if (btn.nextElementSibling) btn.nextElementSibling.classList.add('hidden');
                }
            });

            // 2. Diesen Button umschalten
            if (wasOpen) {
                dropdownBtn.classList.remove('expanded');
                if(dropdownBtn.nextElementSibling) dropdownBtn.nextElementSibling.classList.add('hidden');
            } else {
                dropdownBtn.classList.add('expanded');
                if(dropdownBtn.nextElementSibling) dropdownBtn.nextElementSibling.classList.remove('hidden');
            }
            return;
        }

        // --- D) NAVIGATIONS LINKS (<a>) ---
        // Jeder Link, egal wo (im Header, im Dropdown, im Footer) schließt das Menü.
        const link = target.closest('a');
        if (link) {
            // ZUERST: Alles schließen!
            resetMenu();

            // DANN: Smooth Scroll Logik für #sections
            if (link.hash && link.origin === window.location.origin && link.pathname === window.location.pathname) {
                const el = document.querySelector(link.hash);
                if (el) {
                    e.preventDefault();
                    // Kleines Delay (10ms), damit der Browser das Zuklappen (resetMenu) rendern kann
                    // bevor er die Scroll-Position berechnet.
                    setTimeout(() => {
                        const headerHeight = getHeaderHeight();
                        const targetPos = el.getBoundingClientRect().top + window.scrollY;
                        window.scrollTo({ top: targetPos - headerHeight, behavior: 'smooth' });
                        history.pushState(null, null, link.hash);
                    }, 10);
                }
            }
            return;
        }

        // --- E) KLICK DANEBEN (OUTSIDE) ---
        // Wenn Klick nicht im Nav und nicht auf Hamburger -> Alles zu
        if (!target.closest('#header nav') && !target.closest('[data-aw-toggle-menu]')) {
            resetMenu();
        }
      };

      document.addEventListener('click', handleGlobalClick, { capture: true });
      cleanupFns.push(() => document.removeEventListener('click', handleGlobalClick, { capture: true }));
    };

    // --- 4. ANIMATIONS & SCROLL UI ---
    const initScrollAndAnim = () => {
       const header = document.querySelector('#header[data-aw-sticky-header]');
       if(header) {
           const onScroll = () => header.classList.toggle('scroll', window.scrollY > 10);
           window.addEventListener('scroll', onScroll, {passive: true});
           if(window.scrollY > 10) header.classList.add('scroll');
           cleanupFns.push(() => window.removeEventListener('scroll', onScroll));
       }

       const elements = document.querySelectorAll('.intersect, [class*="intersect:"]');
       if(elements.length) {
           const observer = new IntersectionObserver(entries => {
               entries.forEach(entry => {
                   if(entry.isIntersecting) {
                       entry.target.setAttribute('data-aw-animated', 'true');
                       if (entry.target.classList.contains('intersect-once')) observer.unobserve(entry.target);
                   }
               });
           }, {threshold: 0.1});
           elements.forEach(el => observer.observe(el));
           cleanupFns.push(() => observer.disconnect());
       }
    };

    // --- 5. RUN ---
    const run = () => {
      cleanupFns.forEach(fn => fn());
      cleanupFns = [];

      applyTheme(localStorage.getItem('theme') || defaultTheme);
      initScrollAndAnim();
      initGlobalListener();

      // Fix für Reload an Hash-Position
      if (window.location.hash) {
          const target = document.querySelector(window.location.hash);
          if (target) {
              setTimeout(() => {
                  const h = getHeaderHeight();
                  const pos = target.getBoundingClientRect().top + window.scrollY;
                  window.scrollTo({ top: pos - h, behavior: 'instant' });
              }, 100);
          }
      }
    };

    run();
    document.addEventListener('astro:after-swap', run);
  })();
</script>
