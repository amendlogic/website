---
import { UI } from 'astrowind:config';
---

<script is:inline>
  (function() {
    // Verhindert doppelte Initialisierung bei Astro-Transitions
    if (window.basic_script_init) return;
    window.basic_script_init = true;

    let _cleanupFns = [];

    const init = () => {
      const html = document.documentElement;
      const header = document.getElementById('header');
      const menuBtn = document.querySelector('[data-aw-toggle-menu]');
      const nav = header?.querySelector('nav');

      // 1. INITIALER HASH-JUMP (FIX FÜR REFRESH)
      // Wir starten mit "auto", damit der Browser beim Laden nicht animiert
      html.style.scrollBehavior = 'auto';
      
      if (window.location.hash) {
        const target = document.querySelector(window.location.hash);
        if (target) {
          // Kleiner Delay, damit Astro das Layout fertig rendern kann
          setTimeout(() => {
            target.scrollIntoView();
            html.style.scrollBehavior = 'smooth';
          }, 10);
        }
      } else {
        // Wenn kein Hash da ist, direkt auf smooth für spätere Klicks
        setTimeout(() => { html.style.scrollBehavior = 'smooth'; }, 100);
      }

      // 2. MENÜ LOGIK
      const toggleMenu = (forceClose = false) => {
        const isExpanded = header?.classList.contains('expanded');
        if (forceClose && !isExpanded) return;

        const shouldOpen = forceClose ? false : !isExpanded;

        // UI Updates
        header?.classList.toggle('expanded', shouldOpen);
        header?.classList.toggle('h-screen', shouldOpen);
        document.body.classList.toggle('overflow-hidden', shouldOpen);
        menuBtn?.classList.toggle('expanded', shouldOpen);
        nav?.classList.toggle('hidden', !shouldOpen);

        // Icon Swap (AstroWind spezifisch)
        const icons = menuBtn?.querySelectorAll('svg, [data-aw-icon]');
        if (icons?.length > 1) {
          icons[0].classList.toggle('hidden', shouldOpen);
          icons[1].classList.toggle('hidden', !shouldOpen);
        }
      };

      // 3. GLOBAL CLICK HANDLER (SMART DELEGATION)
      const onGlobalClick = (e) => {
        const link = e.target.closest('a');
        
        // Theme Toggle
        if (e.target.closest('[data-aw-toggle-color-scheme]')) {
          const themes = ['system', 'light', 'dark'];
          const current = localStorage.getItem('theme') || 'system';
          const next = themes[(themes.indexOf(current) + 1) % 3];
          localStorage.setItem('theme', next);
          
          const resolved = next === 'system' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : next;
          html.classList.toggle('dark', resolved === 'dark');
          return;
        }

        // Anker-Link Logik
        if (link && link.hash && link.origin === window.location.origin && link.pathname === window.location.pathname) {
          // WICHTIG: Erst das Menü schließen, um overflow-hidden zu entfernen
          if (header?.classList.contains('expanded')) {
            toggleMenu(true);
          }

          // Wenn der Browser smooth scroll nativ unterstützt, lassen wir ihn machen.
          // Wir nutzen scrollIntoView nur als Backup oder für exaktes Timing.
          const target = document.querySelector(link.hash);
          if (target) {
            // Wir lassen einen winzigen Moment Zeit, damit 'overflow-hidden' 
            // vom Body verschwindet, bevor der Scroll startet.
            e.preventDefault();
            requestAnimationFrame(() => {
              target.scrollIntoView({ behavior: 'smooth' });
              history.pushState(null, null, link.hash);
            });
          }
        }
      };

      // Event Listener
      menuBtn && (menuBtn.onclick = () => toggleMenu());
      document.addEventListener('click', onGlobalClick, { capture: true });
      
      _cleanupFns.push(() => {
        document.removeEventListener('click', onGlobalClick);
        if (menuBtn) menuBtn.onclick = null;
      });
    };

    // Animationen (Intersection Observer)
    const initAnimations = () => {
      const elements = document.querySelectorAll('[class*="intersect:"]');
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.setAttribute('data-aw-animated', 'true');
          }
        });
      }, { threshold: 0.15 });
      elements.forEach(el => observer.observe(el));
      _cleanupFns.push(() => observer.disconnect());
    };

    // Initialisierung & Astro Lifecycle
    const run = () => {
      _cleanupFns.forEach(fn => fn());
      _cleanupFns = [];
      init();
      if (window.requestIdleCallback) window.requestIdleCallback(initAnimations);
      else setTimeout(initAnimations, 200);
    };

    run();
    document.addEventListener('astro:after-swap', run);
  })();
</script>

<style is:global>
  /* Verhindert das Scrollen beim Laden, falls das JS noch nicht gefeuert hat */
  :root {
    scroll-behavior: auto;
  }

  /* Wenn das Menü offen ist, darf NICHT gescrollt werden */
  body.overflow-hidden {
    overflow: hidden !important;
  }

  /* Sobald JS bereit ist, wird Smooth Scroll über das Style-Attribut 
     oder diese Klasse gesteuert */
  .smooth-ready {
    scroll-behavior: smooth;
  }

  /* Dein bereits eingefügtes Scroll-Margin-Top wirkt hier perfekt mit scrollIntoView() */
  [id] {
    scroll-margin-top: 5rem; /* ca. 80px Offset */
  }

  /* Performance: Header-Animationen ausschalten, wenn er 'expanded' ist, 
     damit der Scrollvorgang sofort CPU-Priorität bekommt */
  #header.expanded {
    transition: none !important;
  }
</style>