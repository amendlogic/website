---
import { UI } from 'astrowind:config';
---

<script is:inline define:vars={{ defaultTheme: UI.theme || 'system' }}>
  if (window.basic_script) return;
  window.basic_script = true;

  // --- PERFORMANCE HELPERS ---
  const debounce = (fn, delay) => {
    let timeout;
    return (...args) => {
      clearTimeout(timeout);
      timeout = setTimeout(() => fn(...args), delay);
    };
  };

  // --- THEME LOGIK ---
  function applyTheme(theme) {
    const resolvedTheme = (theme === 'system') 
      ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') 
      : theme;

    document.documentElement.classList.toggle('dark', resolvedTheme === 'dark');
    
    document.querySelectorAll('[data-aw-theme-icon]').forEach((icon) => {
      icon.classList.toggle('hidden', icon.getAttribute('data-aw-theme-icon') !== theme);
    });
    
    window.Observer?.removeAnimationDelay();
  }

  // --- CORE SETUP ---
  const setup = () => {
    const header = document.getElementById('header');

    // Menü-Toggle
    const toggleMenu = () => {
      const menuBtn = document.querySelector('[data-aw-toggle-menu]');
      if (!menuBtn) return;
      menuBtn.classList.toggle('expanded');
      document.body.classList.toggle('overflow-hidden');
      header?.classList.toggle('h-screen');
      header?.classList.toggle('expanded');
      header?.classList.toggle('bg-page');
      document.querySelector('#header nav')?.classList.toggle('hidden');
      document.querySelector('#header > div > div:last-child')?.classList.toggle('hidden');
    };

    document.querySelectorAll('[data-aw-toggle-menu]').forEach(el => el.onclick = toggleMenu);

    // Theme-Toggle Rotation
    const toggleTheme = () => {
      if (defaultTheme.endsWith(':only')) return;
      const themes = ['system', 'light', 'dark'];
      const current = localStorage.getItem('theme') || 'system';
      const next = themes[(themes.indexOf(current) + 1) % 3];
      localStorage.setItem('theme', next);
      applyTheme(next);
    };

    document.querySelectorAll('[data-aw-toggle-color-scheme]').forEach(el => el.onclick = toggleTheme);

    // Sticky Header (Debounced für flüssiges Resizing/Scrolling)
    const header = document.querySelector('#header[data-aw-sticky-header]');
      if (!header) return;
      if (lastKnownScrollPosition > 60 && !header.classList.contains('scroll')) {
        header.classList.add('scroll');
      } else if (lastKnownScrollPosition <= 60 && header.classList.contains('scroll')) {
        header.classList.remove('scroll');
      }
      ticking = false;

  const onPageLoad = () => {
    applyTheme(localStorage.getItem('theme') || 'system');
    setup();
    window.Observer?.start();
  };

  window.onload = onPageLoad;
  document.addEventListener('astro:after-swap', onPageLoad);
</script>

<script is:inline>
  // --- OPTIMIERTER INTERSECTION OBSERVER ---
  window.Observer = {
    observer: null,
    start() {
      const init = () => {
        const els = Array.from(document.querySelectorAll('[class*="intersect"]'));
        if (!els.length) return;

        this.observer = new IntersectionObserver((entries) => {
          entries.forEach((entry) => {
            const target = entry.target;
            if (entry.isIntersecting) {
              if (!target.hasAttribute('data-animated')) {
                target.removeAttribute('no-intersect');
                target.setAttribute('data-animated', 'true');
                if (target.classList.contains('intersect-once')) this.observer.unobserve(target);
              }
            } else if (!target.classList.contains('intersect-once')) {
              target.setAttribute('no-intersect', '');
              target.removeAttribute('data-animated');
            }
          });
        }, { threshold: 0.1 });

        els.forEach(el => this.observer.observe(el));
      };

      // Führt Animation-Check nur aus, wenn der Browser gerade nicht mit Layout/Text beschäftigt ist
      (window.requestIdleCallback || ((cb) => setTimeout(cb, 100)))(init);
    },
    removeAnimationDelay() {
      document.querySelectorAll('[data-animated]').forEach(el => {
        el.style.transitionDelay = '0ms';
        el.style.animationDelay = '0ms';
      });
    }
  };
</script>
