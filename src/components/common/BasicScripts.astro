---
import { UI } from 'astrowind:config';
---

<script is:inline define:vars={{ defaultTheme: UI.theme || 'system' }}>
  if (window.basic_script_init) return;
  window.basic_script_init = true;

  (function() {
    let cleanup = [];
    const doc = document.documentElement;

    // --- UTILS ---
    const toggle = (el, c, condition) => el?.classList.toggle(c, condition);
    const getHeaderHeight = () => document.getElementById('header')?.getBoundingClientRect().height || 0;

    // --- THEME ---
    const applyTheme = (theme) => {
      const mode = theme === 'system' 
        ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') 
        : theme;
      toggle(doc, 'dark', mode === 'dark');
      document.querySelectorAll('[data-aw-theme-icon]').forEach(el => {
        toggle(el, 'hidden', el.getAttribute('data-aw-theme-icon') !== theme);
      });
    };

    // --- SCROLL HANDLING (Sticky Header & Hash Fix) ---
    const initScroll = () => {
      const header = document.querySelector('#header[data-aw-sticky-header]');
      
      const onScroll = () => {
        if (!header) return;
        // Einfachere Throttling-Logik via rAF
        requestAnimationFrame(() => toggle(header, 'scroll', window.scrollY > 10));
      };

      // FIX: Beim Laden/Refresh korrekte Position ansteuern (Header-Offset)
      const checkHashPosition = () => {
        if (window.location.hash) {
          const target = document.querySelector(window.location.hash);
          if (target) {
            setTimeout(() => {
              const offset = target.getBoundingClientRect().top + window.scrollY - getHeaderHeight();
              window.scrollTo({ top: offset, behavior: 'instant' }); // 'instant' beim Refresh verhindert visuelles Springen
            }, 100); // Kleiner Delay für DOM-Rendering
          }
        }
      };

      window.addEventListener('scroll', onScroll, { passive: true });
      cleanup.push(() => window.removeEventListener('scroll', onScroll));
      
      onScroll(); // Init status check
      checkHashPosition(); // Init hash check
    };

    // --- INTERACTIVE (Menu & Clicks) ---
    const initInteractions = () => {
      const header = document.getElementById('header');
      const menuBtn = document.querySelector('[data-aw-toggle-menu]');
      const nav = header?.querySelector('nav');

      // Globaler Click Listener (Delegation Pattern)
      const onClick = (e) => {
        // A) Theme Toggle
        const themeBtn = e.target.closest('[data-aw-toggle-color-scheme]');
        if (themeBtn) {
          const themes = ['system', 'light', 'dark'];
          const next = themes[(themes.indexOf(localStorage.theme || 'system') + 1) % 3];
          localStorage.setItem('theme', next);
          return applyTheme(next);
        }

        // B) Menu Toggle
        if (menuBtn?.contains(e.target)) {
          menuBtn.classList.toggle('expanded');
          toggle(document.body, 'overflow-hidden');
          toggle(header, 'h-screen');
          toggle(header, 'expanded');
          toggle(header, 'bg-page');
          nav?.classList.toggle('hidden');
          header.querySelector('nav + div')?.classList.toggle('hidden');
          
          // Icon Toggle
          const icons = menuBtn.querySelectorAll('svg, [data-aw-icon]');
          if(icons.length > 1) icons.forEach(i => i.classList.toggle('hidden'));
          return;
        }

        // C) Dropdowns (Mobile)
        const dropTrigger = e.target.closest('.dropdown > button, .dropdown > a');
        if (dropTrigger && nav?.contains(dropTrigger) && getComputedStyle(menuBtn).display !== 'none') {
          e.preventDefault();
          dropTrigger.classList.toggle('expanded');
          toggle(dropTrigger.nextElementSibling, 'hidden');
          return;
        }

        // D) Smooth Scroll Links
        const link = e.target.closest('a[href^="#"]');
        if (link && link.origin === location.origin && link.pathname === location.pathname) {
          const target = document.querySelector(link.hash);
          if (target) {
            e.preventDefault();
            // Menü schließen falls offen
            if (header?.classList.contains('expanded')) menuBtn.click();
            
            const offset = target.getBoundingClientRect().top + window.scrollY - getHeaderHeight();
            window.scrollTo({ top: offset, behavior: 'smooth' });
            history.pushState(null, null, link.hash);
          }
        }
      };

      document.addEventListener('click', onClick);
      cleanup.push(() => document.removeEventListener('click', onClick));
    };

    // --- ANIMATIONS ---
    const initAnimations = () => {
      const els = document.querySelectorAll('.intersect-once, .intersect-quarter, [class*="intersect:"]');
      if (!els.length) return;

      const obs = new IntersectionObserver(entries => {
        entries.forEach(e => {
          if (e.isIntersecting) {
            e.target.setAttribute('data-aw-animated', 'true');
            if (e.target.classList.contains('intersect-once')) obs.unobserve(e.target);
          }
        });
      }, { rootMargin: '-10% 0px' }); // Etwas früher triggern

      els.forEach(el => obs.observe(el));
      cleanup.push(() => obs.disconnect());
    };

    // --- LIFECYCLE ---
    const run = () => {
      cleanup.forEach(fn => fn());
      cleanup = [];

      applyTheme(localStorage.getItem('theme') || 'system');
      initScroll();
      initInteractions();
      
      // Animations lazy laden
      (window.requestIdleCallback || setTimeout)(initAnimations, 200);
    };

    run();
    document.addEventListener('astro:after-swap', run);
  })();
</script>
