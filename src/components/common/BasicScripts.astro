---
import { UI } from 'astrowind:config';
---

<script is:inline define:vars={{ defaultTheme: UI.theme || 'system' }}>
if (window.basic_script_init) return;
window.basic_script_init = true;

(function() {
  let cleanupFns = [];

  // --- HELPERS ---
  const toggleClass = (el, className, condition) => {
    if (el) el.classList.toggle(className, !!condition);
  };

  const applyTheme = (theme) => {
    const resolved = theme === 'system'
      ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light')
      : theme;

    document.documentElement.dataset.theme = resolved;

    requestAnimationFrame(() => {
      toggleClass(document.documentElement, 'dark', resolved === 'dark');
      document.querySelectorAll('[data-aw-theme-icon]').forEach(icon => {
        const iconTheme = icon.getAttribute('data-aw-theme-icon');
        icon.classList.toggle('hidden', iconTheme !== resolved);
      });
    });
  };

  // --- HEADER SCROLL ---
  const initHeader = () => {
    const stickyHeader = document.querySelector('#header[data-aw-sticky-header]');
    if (!stickyHeader) return;

    let lastState = window.scrollY > 60;
    toggleClass(stickyHeader, 'scroll', lastState);

    const onScroll = () => {
      const isScrolled = window.scrollY > 60;
      if (isScrolled !== lastState) {
        toggleClass(stickyHeader, 'scroll', isScrolled);
        lastState = isScrolled;
      }
    };

    window.addEventListener('scroll', onScroll, { passive: true });
    cleanupFns.push(() => window.removeEventListener('scroll', onScroll));
  };

  // --- MENU LOGIC ---
  const initMenu = () => {
    const header = document.getElementById('header');
    const menuBtn = header?.querySelector('[data-aw-toggle-menu]');
    const nav = header?.querySelector('nav');
    if (!menuBtn || !nav) return;

    menuBtn.setAttribute('aria-expanded', 'false');

    // Funktion zum sauberen Umschalten der Icons
    const toggleIcons = (isExpanded) => {
        const icons = menuBtn.querySelectorAll('svg, [data-aw-icon]');
        // Annahme: Icon 0 = Hamburger, Icon 1 = Close (X)
        if (icons.length > 1) {
            icons[0].classList.toggle('hidden', isExpanded); // Hamburger weg wenn offen
            icons[1].classList.toggle('hidden', !isExpanded); // X weg wenn zu
        } else if (icons.length === 1) {
            // Fallback falls nur ein Icon da ist
            icons[0].classList.toggle('hidden', isExpanded);
        }
    };

    const toggleMenu = () => {
      const isExpanded = menuBtn.classList.toggle('expanded');
      document.body.classList.toggle('overflow-hidden', isExpanded);
      header.classList.toggle('h-screen', isExpanded);
      header.classList.toggle('expanded', isExpanded);
      header.classList.toggle('bg-page', isExpanded);

      menuBtn.setAttribute('aria-expanded', isExpanded);
      toggleIcons(isExpanded);

      nav.classList.toggle('hidden');

      const actions = header.querySelector('nav + div, div > div:last-child');
      if (actions) actions.classList.toggle('hidden', !isExpanded);
    };

    // Externe Schließ-Funktion für Links
    window.closeMenuInstance = () => {
        if (menuBtn.classList.contains('expanded')) {
            toggleMenu(); // Nutzt die gleiche Logik, setzt alles sauber zurück
        }
    };

    menuBtn.addEventListener('click', toggleMenu);
    cleanupFns.push(() => menuBtn.removeEventListener('click', toggleMenu));

    // Dropdown Logic
    const onNavClick = (e) => {
      const trigger = e.target.closest('.dropdown > button, .dropdown > a');
      if (!trigger || window.getComputedStyle(menuBtn).display === 'none') return;

      e.preventDefault();
      const subMenu = trigger.nextElementSibling;
      if (subMenu) {
        const expanded = subMenu.classList.toggle('hidden') === false;
        trigger.classList.toggle('expanded', expanded);
        trigger.setAttribute('aria-expanded', expanded);
      }
    };

    nav.addEventListener('click', onNavClick);
    cleanupFns.push(() => nav.removeEventListener('click', onNavClick));
  };

  // --- GLOBAL EVENTS (Links & Smooth Scroll) ---
  const initGlobalEvents = () => {
    const onClick = (e) => {
      // Theme Toggle
      const themeBtn = e.target.closest('[data-aw-toggle-color-scheme]');
      if (themeBtn) {
        const themes = ['system', 'light', 'dark'];
        const current = localStorage.getItem('theme') || 'system';
        const next = themes[(themes.indexOf(current) + 1) % 3];
        localStorage.setItem('theme', next);
        applyTheme(next);
        return;
      }

      // Link Handling
      const link = e.target.closest('a');
      if (link && link.hash && link.origin === window.location.origin && link.pathname === window.location.pathname) {
        const decodedHash = decodeURIComponent(link.hash);
        let targetEl = null;

        try {
          targetEl = decodedHash === '#' ? null : document.querySelector(decodedHash);
        } catch (error) {
          console.warn('Invalid hash selector:', decodedHash);
        }

        if (targetEl) {
          e.preventDefault();
          link.blur();

          // FIX: Prüfen ob Menü offen ist
          const isMenuOpen = document.getElementById('header')?.classList.contains('expanded');

          // Schritt 1: Menü schließen falls offen
          if (isMenuOpen && window.closeMenuInstance) {
            window.closeMenuInstance();
          }

          // Schritt 2: Scrollen (Mit Verzögerung für Mobile Layout Reflow)
          // Wir warten 10ms, damit 'overflow-hidden' sicher vom Body entfernt ist
          setTimeout(() => {
             const header = document.getElementById('header');
             const headerHeight = header ? header.getBoundingClientRect().height : 0;
             const targetPos = targetEl.getBoundingClientRect().top + window.scrollY;
             
             window.scrollTo({ top: targetPos - headerHeight, behavior: 'smooth' });
             history.pushState(null, null, link.hash);
          }, isMenuOpen ? 10 : 0); 
        }
      }
    };

    document.addEventListener('click', onClick, { capture: true, passive: false });
    cleanupFns.push(() => document.removeEventListener('click', onClick, { capture: true }));
  };

  // --- ANIMATIONS ---
  const initAnimations = () => {
    const selectors = ['[class*=" intersect:"]','[class*=":intersect:"]','[class^="intersect:"]','[class="intersect"]','.intersect-once','.intersect-quarter'];
    const elements = document.querySelectorAll(selectors.join(','));
    if (!elements.length) return;

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const el = entry.target;
          el.setAttribute('data-aw-animated', 'true');
          el.removeAttribute('no-intersect');
          if (el.classList.contains('intersect-once')) observer.unobserve(el);
        }
      });
    }, { threshold: 0.1, rootMargin: '0px 0px -10% 0px' });

    elements.forEach(el => {
      el.setAttribute('no-intersect', '');
      observer.observe(el);
    });

    cleanupFns.push(() => observer.disconnect());
  };

  // --- SCROLL FIX ON LOAD ---
  const fixScrollPosition = () => {
    if (!window.location.hash) return;
    const decodedHash = decodeURIComponent(window.location.hash);
    
    try {
      const target = decodedHash === '#' ? null : document.querySelector(decodedHash);
      if (!target) return;

      setTimeout(() => {
        const headerHeight = document.getElementById('header')?.getBoundingClientRect().height || 0;
        const targetPos = target.getBoundingClientRect().top + window.scrollY;
        window.scrollTo({ top: targetPos - headerHeight, behavior: 'instant' });
      }, 50); // Leicht erhöhtes Timeout für sichereres Laden
    } catch (e) {}
  };

  // --- MAIN RUN ---
  const run = () => {
    cleanupFns.forEach(fn => fn());
    cleanupFns = [];

    applyTheme(localStorage.getItem('theme') || 'system');

    initHeader();
    initMenu();
    setTimeout(initGlobalEvents, 0);
    fixScrollPosition();

    if (window.requestIdleCallback) window.requestIdleCallback(initAnimations);
    else setTimeout(initAnimations, 200);
  };

  run();
  document.addEventListener('astro:after-swap', run);
})();
</script>