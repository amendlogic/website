---
import { UI } from 'astrowind:config';
---

<script is:inline define:vars={{ defaultTheme: UI.theme || 'system' }}>
  // Verhindert mehrfache Ausführung, falls Astro das Script neu injectet
  if (window.basic_script_init) return;
  window.basic_script_init = true;

  (function() {
    let cleanupFns = []; // Stack für Cleanup-Funktionen

    // --- UTILS ---
    const attachEvent = (selector, event, fn) => {
      const elements = document.querySelectorAll(selector);
      elements.forEach(el => el.addEventListener(event, fn));
      // Keine Cleanup nötig für Element-Listener, da Astro den Body tauscht
    };

    // --- THEME LOGIK ---
    const applyTheme = (theme) => {
      const resolvedTheme = (theme === 'system') 
        ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') 
        : theme;
      
      document.documentElement.classList.toggle('dark', resolvedTheme === 'dark');
      
      document.querySelectorAll('[data-aw-theme-icon]').forEach((icon) => {
        icon.classList.toggle('hidden', icon.getAttribute('data-aw-theme-icon') !== theme);
      });
    };

    const themeObserver = window.matchMedia('(prefers-color-scheme: dark)');
    const themeHandler = () => {
      if (localStorage.getItem('theme') === 'system') applyTheme('system');
    };
    themeObserver.addEventListener('change', themeHandler);
    // Globalen Listener merken für Cleanup wäre hier perfekt, aber für App-Lebensdauer okay.

    // --- SCROLL HANDLER (Ultra-Performance + Cleanup) ---
    const initScroll = () => {
      const stickyHeader = document.querySelector('#header[data-aw-sticky-header]');
      if (!stickyHeader) return;

      let isTicking = false;
      let lastState = false; // State-Cache um DOM-Zugriffe zu minimieren

      const onScroll = () => {
        if (!isTicking) {
          window.requestAnimationFrame(() => {
            const isScrolled = window.scrollY > 10;
            // Nur DOM anfassen, wenn sich der State ändert!
            if (isScrolled !== lastState) {
              stickyHeader.classList.toggle('scroll', isScrolled);
              lastState = isScrolled;
            }
            isTicking = false;
          });
          isTicking = true;
        }
      };

      window.addEventListener('scroll', onScroll, { passive: true });
      
      // Initialer Check
      const isScrolled = window.scrollY > 10;
      if(isScrolled) stickyHeader.classList.add('scroll');
      lastState = isScrolled;

      // WICHTIG: Cleanup registrieren
      cleanupFns.push(() => window.removeEventListener('scroll', onScroll));
    };

    // --- SETUP ---
    const setup = () => {
      // 1. Header Menü
      const header = document.getElementById('header');
      const toggleMenu = (e) => {
        const btn = e.currentTarget;
        btn.classList.toggle('expanded');
        document.body.classList.toggle('overflow-hidden');
        header?.classList.toggle('h-screen');
        header?.classList.toggle('expanded');
        header?.classList.toggle('bg-page');
        document.querySelector('#header nav')?.classList.toggle('hidden');
        document.querySelector('#header > div > div:last-child')?.classList.toggle('hidden');
      };
      attachEvent('[data-aw-toggle-menu]', 'click', toggleMenu);

      // 2. Theme Toggle
      attachEvent('[data-aw-toggle-color-scheme]', 'click', () => {
        if (defaultTheme.endsWith(':only')) return;
        const themes = ['system', 'light', 'dark'];
        const current = localStorage.getItem('theme') || 'system';
        const next = themes[(themes.indexOf(current) + 1) % 3];
        localStorage.setItem('theme', next);
        applyTheme(next);
      });

      // 3. Social Share
      attachEvent('[data-aw-social-share]', 'click', (e) => {
        const el = e.currentTarget;
        const network = el.getAttribute('data-aw-social-share');
        const url = encodeURIComponent(el.getAttribute('data-aw-url') || window.location.href);
        const text = encodeURIComponent(el.getAttribute('data-aw-text') || '');
        // ... (Share Logik hier, gekürzt für Übersicht)
        const href = network === 'mail' ? `mailto:?subject=${text}&body=${url}` : '#'; 
        // Für einfaches Beispiel: window.open logic hier einfügen
      });

      // 4. Scroll Logic starten
      initScroll();
    };

    // --- OBSERVER (Singleton Pattern) ---
    let observerInstance = null;
    
    const initObserver = () => {
      if (observerInstance) observerInstance.disconnect(); // Alten Observer töten

      const els = document.querySelectorAll('[class*="intersect"]');
      if (els.length === 0) return;

      const callback = (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const t = entry.target;
            if (!t.dataset.animated) {
              t.dataset.animated = 'true';
              t.removeAttribute('no-intersect');
              if (t.classList.contains('intersect-once')) observerInstance.unobserve(t);
            }
          } else if (!entry.target.classList.contains('intersect-once')) {
            entry.target.removeAttribute('data-animated');
            entry.target.setAttribute('no-intersect', '');
          }
        });
      };

      observerInstance = new IntersectionObserver(callback, { threshold: 0.1 });
      els.forEach(el => observerInstance.observe(el));
      
      cleanupFns.push(() => observerInstance.disconnect());
    };

    // --- LIFECYCLE MANAGEMENT ---
    const run = () => {
      // Alte Cleanups ausführen bevor wir neu initialisieren
      cleanupFns.forEach(fn => fn());
      cleanupFns = [];

      applyTheme(localStorage.getItem('theme') || 'system');
      setup();
      
      // Idle Execution für Observer
      if (window.requestIdleCallback) {
        window.requestIdleCallback(initObserver);
      } else {
        setTimeout(initObserver, 200);
      }
    };

    // Start
    run();
    document.addEventListener('astro:after-swap', run);
  })();
</script>
