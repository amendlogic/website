---
import { UI } from 'astrowind:config';
---

<script is:inline define:vars={{ defaultTheme: UI.theme || 'system' }}>
  // Schutz vor doppelter Ausführung
  if (window.basic_script_init) return;
  window.basic_script_init = true;

  (function() {
    let cleanupFns = [];

    // --- HELPER ---
    const getHeaderHeight = () => {
      const header = document.getElementById('header');
      return header ? header.getBoundingClientRect().height : 0;
    };

    const toggleClass = (el, cls, condition) => {
        if(condition) el.classList.add(cls); else el.classList.remove(cls);
    };

    // --- CORE FUNCTIONS (ACTIONS) ---

    // 1. Schließt ALLES (Mobile Menu & alle Dropdowns)
    const closeAll = () => {
        // Dropdowns zu
        document.querySelectorAll('.dropdown > .expanded').forEach(el => {
            el.classList.remove('expanded');
            if (el.nextElementSibling) el.nextElementSibling.classList.add('hidden');
        });
        
        // Mobile Menu zu
        const menuBtn = document.querySelector('[data-aw-toggle-menu]');
        if (menuBtn && menuBtn.classList.contains('expanded')) {
            menuBtn.classList.remove('expanded');
            document.body.classList.remove('overflow-hidden');
            const header = document.getElementById('header');
            if(header) {
                header.classList.remove('h-screen', 'expanded', 'bg-page');
                const nav = header.querySelector('nav');
                if(nav) nav.classList.add('hidden');
                header.querySelector('div > div:last-child')?.classList.add('hidden'); // Actions
            }
        }
    };

    // 2. Nur Dropdowns schließen (behält Mobile Menu offen, falls man drin ist)
    const closeDropdownsOnly = () => {
        document.querySelectorAll('.dropdown > .expanded').forEach(el => {
            el.classList.remove('expanded');
            if (el.nextElementSibling) el.nextElementSibling.classList.add('hidden');
        });
    };

    // 3. Theme
    const applyTheme = (theme) => {
      const resolvedTheme = (theme === 'system') 
        ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') 
        : theme;
      
      requestAnimationFrame(() => {
        toggleClass(document.documentElement, 'dark', resolvedTheme === 'dark');
        document.querySelectorAll('[data-aw-theme-icon]').forEach((icon) => {
          toggleClass(icon, 'hidden', icon.getAttribute('data-aw-theme-icon') !== theme);
        });
      });
    };

    // --- INIT MODULES ---

    const initHeader = () => {
      const stickyHeader = document.querySelector('#header[data-aw-sticky-header]');
      if (!stickyHeader) return;
      
      const onScroll = () => {
         window.requestAnimationFrame(() => {
             stickyHeader.classList.toggle('scroll', window.scrollY > 10);
         });
      };
      
      window.addEventListener('scroll', onScroll, { passive: true });
      if (window.scrollY > 10) stickyHeader.classList.add('scroll');
      cleanupFns.push(() => window.removeEventListener('scroll', onScroll));
    };

    // --- CENTRAL EVENT LISTENER (THE BRAIN) ---
    // Ersetzt alle einzelnen Listener für maximale Kontrolle
    const initGlobalListener = () => {
      
      const handleGlobalClick = (e) => {
        const target = e.target;

        // A) Theme Button
        const themeBtn = target.closest('[data-aw-toggle-color-scheme]');
        if (themeBtn) {
            e.preventDefault();
            const themes = ['system', 'light', 'dark'];
            const current = localStorage.getItem('theme') || 'system';
            const next = themes[(themes.indexOf(current) + 1) % 3];
            localStorage.setItem('theme', next);
            applyTheme(next);
            return;
        }

        // B) Mobile Menu Toggle (Hamburger)
        const menuBtn = target.closest('[data-aw-toggle-menu]');
        if (menuBtn) {
            e.stopPropagation(); // Stop, damit "Close All" nicht sofort feuert
            const header = document.getElementById('header');
            const nav = header?.querySelector('nav');
            
            // Status toggeln
            menuBtn.classList.toggle('expanded');
            document.body.classList.toggle('overflow-hidden');
            header?.classList.toggle('h-screen');
            header?.classList.toggle('expanded');
            header?.classList.toggle('bg-page');
            nav?.classList.toggle('hidden');
            
            // Wenn wir das Menü schließen, auch Dropdowns resetten
            if (!menuBtn.classList.contains('expanded')) {
                closeDropdownsOnly();
            }
            return;
        }

        // C) Dropdown Toggle (Der Titel/Pfeil)
        const dropdownTrigger = target.closest('.dropdown > button, .dropdown > a');
        if (dropdownTrigger) {
            // Logik: Toggle (Auf/Zu)
            e.preventDefault();
            e.stopPropagation(); // Isoliert den Klick

            const wasOpen = dropdownTrigger.classList.contains('expanded');
            
            // 1. Erstmal ALLE Dropdowns schließen (Reset)
            // Das löst das Problem, dass alte offen bleiben
            closeDropdownsOnly();

            // 2. Wenn es vorher NICHT offen war -> Jetzt öffnen
            // Wenn es vorher offen war, bleibt es durch Schritt 1 jetzt zu (Toggle-Effekt)
            if (!wasOpen) {
                dropdownTrigger.classList.add('expanded');
                if(dropdownTrigger.nextElementSibling) dropdownTrigger.nextElementSibling.classList.remove('hidden');
            }
            return;
        }

        // D) Links (Navigation & Smooth Scroll)
        const link = target.closest('a');
        if (link) {
            // Bei JEDEM Link-Klick: Alles aufräumen
            closeAll();

            // Ist es ein Anchor-Link (#section)?
            if (link.hash && link.origin === window.location.origin && link.pathname === window.location.pathname) {
                const el = document.querySelector(link.hash);
                if (el) {
                    e.preventDefault();
                    const headerHeight = getHeaderHeight();
                    const targetPos = el.getBoundingClientRect().top + window.scrollY;
                    window.scrollTo({ top: targetPos - headerHeight, behavior: 'smooth' });
                    history.pushState(null, null, link.hash);
                }
            }
            return;
        }

        // E) Klick irgendwo anders hin (Hintergrund, Text)
        // Prüfen: Haben wir NICHT ins Nav geklickt?
        if (!target.closest('#header nav') && !target.closest('[data-aw-toggle-menu]')) {
            closeAll();
        }
      };

      document.addEventListener('click', handleGlobalClick, { capture: true, passive: false });
      cleanupFns.push(() => document.removeEventListener('click', handleGlobalClick, { capture: true }));
    };

    // --- ANIMATIONS ---
    const initAnimations = () => {
       const elements = document.querySelectorAll('.intersect, [class*="intersect:"]');
       if(!elements.length) return;
       const observer = new IntersectionObserver(entries => {
           entries.forEach(entry => {
               if(entry.isIntersecting) {
                   entry.target.setAttribute('data-aw-animated', 'true');
                   if (entry.target.classList.contains('intersect-once')) observer.unobserve(entry.target);
               }
           });
       }, {threshold: 0.1});
       elements.forEach(el => observer.observe(el));
       cleanupFns.push(() => observer.disconnect());
    };

    // --- RELOAD FIX ---
    const fixInitialHashScroll = () => {
        if (window.location.hash) {
            const target = document.querySelector(window.location.hash);
            if (target) {
                setTimeout(() => {
                    const headerHeight = getHeaderHeight();
                    const targetPos = target.getBoundingClientRect().top + window.scrollY;
                    window.scrollTo({ top: targetPos - headerHeight, behavior: 'instant' });
                }, 10); // Kleines Delay für Layout-Shift Sicherheit
            }
        }
    };

    // --- MAIN RUN ---
    const run = () => {
      cleanupFns.forEach(fn => fn());
      cleanupFns = [];

      applyTheme(localStorage.getItem('theme') || defaultTheme);
      initHeader();
      initGlobalListener(); // <-- Der neue, zentrale Listener
      fixInitialHashScroll();

      if (window.requestIdleCallback) window.requestIdleCallback(initAnimations);
      else setTimeout(initAnimations, 200);
    };

    run();
    document.addEventListener('astro:after-swap', run);
  })();
</script>
