---
import { UI } from 'astrowind:config';
---

<script is:inline define:vars={{ defaultTheme: UI.theme || 'system' }}>
if (window.basic_script_init) return;
window.basic_script_init = true;

(() => {
  const cleanupFns = new Set();

  // ========== HELPERS ==========
  const addCleanup = (fn) => cleanupFns.add(fn);

  const toggleClass = (el, cls, condition) =>
    el?.classList.toggle(cls, !!condition);

  const getSystemTheme = () =>
    window.matchMedia('(prefers-color-scheme: dark)').matches
      ? 'dark'
      : 'light';

  const applyTheme = (theme = 'system') => {
    const resolved =
      theme === 'system' ? getSystemTheme() : theme;

    requestAnimationFrame(() => {
      toggleClass(document.documentElement, 'dark', resolved === 'dark');

      document
        .querySelectorAll('[data-aw-theme-icon]')
        .forEach((icon) =>
          toggleClass(
            icon,
            'hidden',
            icon.dataset.awThemeIcon !== theme
          )
        );
    });
  };

  // ========== 1) HEADER (scroll-optimiert) ==========
  const initHeader = () => {
    const stickyHeader = document.querySelector(
      '#header[data-aw-sticky-header]'
    );
    if (!stickyHeader) return;

    let lastState = window.scrollY > 10;
    toggleClass(stickyHeader, 'scroll', lastState);

    const onScroll = () => {
      const isScrolled = window.scrollY > 10;
      if (isScrolled !== lastState) {
        toggleClass(stickyHeader, 'scroll', isScrolled);
        lastState = isScrolled;
      }
    };

    window.addEventListener('scroll', onScroll, { passive: true });
    addCleanup(() =>
      window.removeEventListener('scroll', onScroll)
    );
  };

  // ========== 2) MENU (stabil + sauberer) ==========
  const initMenu = () => {
    const header = document.getElementById('header');
    const menuBtn = document.querySelector('[data-aw-toggle-menu]');
    const nav = header?.querySelector('nav');

    if (!menuBtn || !header || !nav) return;

    const toggleMenu = () => {
      const isOpen = header.classList.toggle('expanded');

      menuBtn.classList.toggle('expanded', isOpen);
      document.body.classList.toggle('overflow-hidden', isOpen);
      header.classList.toggle('h-screen', isOpen);
      header.classList.toggle('bg-page', isOpen);
      nav.classList.toggle('hidden', !isOpen);

      // Icons flippen
      menuBtn
        .querySelectorAll('svg, [data-aw-icon]')
        .forEach((icon) => icon.classList.toggle('hidden'));

      const actions =
        header.querySelector('nav + div') ||
        header.querySelector('div > div:last-child');

      actions?.classList.toggle('hidden', !isOpen);
    };

    menuBtn.addEventListener('click', toggleMenu);
    window.toggleMenuInstance = toggleMenu;

    const onNavClick = (e) => {
      const trigger = e.target.closest(
        '.dropdown > button, .dropdown > a'
      );

      if (
        !trigger ||
        getComputedStyle(menuBtn).display === 'none'
      )
        return;

      e.preventDefault();

      const subMenu = trigger.nextElementSibling;
      subMenu?.classList.toggle('hidden');
      trigger.classList.toggle('expanded');
    };

    nav.addEventListener('click', onNavClick);
    addCleanup(() =>
      nav.removeEventListener('click', onNavClick)
    );
  };

  // ========== 3) GLOBAL EVENTS (sauber + sicher) ==========
  const initGlobalEvents = () => {
    const onClick = (e) => {
      // Theme Toggle
      const themeBtn = e.target.closest(
        '[data-aw-toggle-color-scheme]'
      );

      if (themeBtn) {
        const themes = ['system', 'light', 'dark'];
        const current =
          localStorage.getItem('theme') || 'system';
        const next =
          themes[(themes.indexOf(current) + 1) % 3];

        localStorage.setItem('theme', next);
        applyTheme(next);
        return;
      }

      // Native Smooth Scroll + Menü schließen
      const link = e.target.closest('a');

      if (
        link &&
        link.hash &&
        link.origin === location.origin &&
        link.pathname === location.pathname
      ) {
        const header = document.getElementById('header');

        if (
          header?.classList.contains('expanded') &&
          window.toggleMenuInstance
        ) {
          window.toggleMenuInstance();
        }
      }
    };

    document.addEventListener('click', onClick, {
      capture: true,
      passive: false,
    });

    addCleanup(() =>
      document.removeEventListener('click', onClick, {
        capture: true,
      })
    );
  };

  // ========== 4) ANIMATIONS (effizienter) ==========
  const initAnimations = () => {
    const elements = document.querySelectorAll(
      [
        '[class*=" intersect:"]',
        '[class*=":intersect:"]',
        '[class^="intersect:"]',
        '[class="intersect"]',
        '.intersect-once',
        '.intersect-quarter',
      ].join(',')
    );

    if (!elements.length) return;

    const observer = new IntersectionObserver(
      (entries, obs) => {
        for (const entry of entries) {
          if (!entry.isIntersecting) continue;

          const el = entry.target;
          el.dataset.awAnimated = 'true';
          el.removeAttribute('no-intersect');

          if (el.classList.contains('intersect-once')) {
            obs.unobserve(el);
          }
        }
      },
      { threshold: 0.1 }
    );

    elements.forEach((el) => {
      el.setAttribute('no-intersect', '');
      observer.observe(el);
    });

    addCleanup(() => observer.disconnect());
  };

  // ========== MAIN RUNNER ==========
  const run = () => {
    cleanupFns.forEach((fn) => fn());
    cleanupFns.clear();

    document.documentElement.classList.add(
      'motion-safe:scroll-smooth'
    );

    applyTheme(localStorage.getItem('theme') || 'system');

    initHeader();
    initMenu();

    queueMicrotask(initGlobalEvents);

    if ('requestIdleCallback' in window) {
      requestIdleCallback(initAnimations);
    } else {
      setTimeout(initAnimations, 150);
    }
  };

  run();
  document.addEventListener('astro:after-swap', run);
})();
</script>