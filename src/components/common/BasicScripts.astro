---
import { UI } from 'astrowind:config';
---

<script is:inline define:vars={{ defaultTheme: UI.theme || 'system' }}>
  // Singleton Check: Verhindert doppeltes Ausführen
  if (window.basic_script_init) return;
  window.basic_script_init = true;

  (function() {
    let cleanupFns = [];

    // --- 1. THEME LOGIK ---
    const applyTheme = (theme) => {
      const resolvedTheme = theme === 'system'
        ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light')
        : theme;
      
      const root = document.documentElement;
      // Native Toggle: Fügt hinzu wenn true, entfernt wenn false
      root.classList.toggle('dark', resolvedTheme === 'dark');

      document.querySelectorAll('[data-aw-theme-icon]').forEach((icon) => {
        icon.classList.toggle('hidden', icon.getAttribute('data-aw-theme-icon') !== theme);
      });
    };

    const initTheme = () => {
      const handleThemeToggle = (e) => {
        const btn = e.target.closest('[data-aw-toggle-color-scheme]');
        if (!btn) return;

        const current = localStorage.getItem('theme') || 'system';
        const themes = ['system', 'light', 'dark'];
        const next = themes[(themes.indexOf(current) + 1) % themes.length];
        
        localStorage.setItem('theme', next);
        applyTheme(next);
      };
      
      document.addEventListener('click', handleThemeToggle);
      cleanupFns.push(() => document.removeEventListener('click', handleThemeToggle));
    };

    // --- 2. HEADER LOGIK (High-Performance rAF) ---
    const initHeader = () => {
      const header = document.querySelector('#header[data-aw-sticky-header]');
      if (!header) return;

      let ticking = false;
      let lastState = window.scrollY > 10;

      // Initial setzen
      header.classList.toggle('scroll', lastState);

      const updateHeader = () => {
        const isScrolled = window.scrollY > 10;
        // DOM nur anfassen, wenn sich der Status wirklich geändert hat!
        if (isScrolled !== lastState) {
          header.classList.toggle('scroll', isScrolled);
          lastState = isScrolled;
        }
        ticking = false;
      };

      const onScroll = () => {
        if (!ticking) {
          window.requestAnimationFrame(updateHeader);
          ticking = true;
        }
      };

      // { passive: true } ist extrem wichtig für Scroll-Performance auf Mobile
      window.addEventListener('scroll', onScroll, { passive: true });
      cleanupFns.push(() => window.removeEventListener('scroll', onScroll));
    };

    // --- 3. MENU LOGIK ---
    const initMenu = () => {
      const header = document.getElementById('header');
      const menuBtn = document.querySelector('[data-aw-toggle-menu]');
      const nav = header?.querySelector('nav');
      
      if (!menuBtn || !header || !nav) return;

      const toggleMenu = () => {
        const isExpanded = menuBtn.classList.toggle('expanded');
        document.body.classList.toggle('overflow-hidden', isExpanded);
        header.classList.toggle('h-screen', isExpanded);
        header.classList.toggle('expanded', isExpanded);
        header.classList.toggle('bg-page', isExpanded);
        
        nav.classList.toggle('hidden', !isExpanded);
        
        // Icons toggeln (Hamburger <-> Kreuz)
        menuBtn.querySelectorAll('svg').forEach(el => el.classList.toggle('hidden'));
        
        // Actions Button (Rechts oben)
        const actions = header.querySelector('nav + div') || header.querySelector('div > div:last-child');
        if (actions) actions.classList.toggle('hidden', isExpanded);
      };

      menuBtn.onclick = toggleMenu;
      window.toggleMenuInstance = toggleMenu; // Für externen Zugriff

      // Dropdown Logik (Event Delegation)
      const onNavClick = (e) => {
        const trigger = e.target.closest('.dropdown > button, .dropdown > a');
        // Nur feuern, wenn wir im Mobile-Mode sind (Menu-Button sichtbar ist)
        if (!trigger || window.getComputedStyle(menuBtn).display === 'none') return;

        e.preventDefault();
        trigger.classList.toggle('expanded');
        const subMenu = trigger.nextElementSibling;
        if (subMenu) subMenu.classList.toggle('hidden');
      };

      nav.addEventListener('click', onNavClick);
    };

    // --- 4. SMOOTH SCROLL (Clean Version) ---
    const initScroll = () => {
      const onClick = (e) => {
        const link = e.target.closest('a[href^="#"]');
        // Checken ob Hash-Link und ob selbe Seite
        if (!link || link.origin !== window.location.origin) return;
        
        const targetId = link.getAttribute('href');
        if(targetId === '#') return;
        
        const targetEl = document.querySelector(targetId);
        if (!targetEl) return;

        e.preventDefault();
        
        // Mobile Menu schließen falls offen
        if (document.getElementById('header')?.classList.contains('expanded')) {
           window.toggleMenuInstance?.();
        }

        const headerHeight = document.getElementById('header')?.getBoundingClientRect().height || 0;
        const targetPos = targetEl.getBoundingClientRect().top + window.scrollY - headerHeight;

        window.scrollTo({ top: targetPos, behavior: 'smooth' });
        history.pushState(null, null, targetId);
      };

      document.addEventListener('click', onClick);
      cleanupFns.push(() => document.removeEventListener('click', onClick));
    };

    // --- 5. ANIMATIONS ---
    const initAnimations = () => {
      const elements = document.querySelectorAll('[class*="intersect"]');
      if (!elements.length) return;

      const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            entry.target.setAttribute('data-aw-animated', 'true');
            if (entry.target.classList.contains('intersect-once')) {
              observer.unobserve(entry.target);
            }
          }
        });
      }, { threshold: 0.1 });

      elements.forEach(el => observer.observe(el));
      cleanupFns.push(() => observer.disconnect());
    };

    // --- MAIN ---
    const run = () => {
      cleanupFns.forEach(fn => fn());
      cleanupFns = [];

      applyTheme(localStorage.getItem('theme') || defaultTheme);
      
      initTheme();
      initHeader();
      initMenu();
      initScroll();
      
      // Animationen niedrig priorisiert laden
      if (window.requestIdleCallback) window.requestIdleCallback(initAnimations);
      else setTimeout(initAnimations, 200);
    };

    run();
    document.addEventListener('astro:after-swap', run);
  })();
</script>
