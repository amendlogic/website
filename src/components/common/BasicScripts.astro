---
import { UI } from 'astrowind:config';
---

<script is:inline define:vars={{ defaultTheme: UI.theme || 'system' }}>
  if (window.basic_script_init) return;
  window.basic_script_init = true;

  (function() {
    let cleanupFns = [];

    // --- HELPER ---
    const getHeaderHeight = () => {
      const header = document.getElementById('header');
      return header ? header.getBoundingClientRect().height : 0;
    };

    // --- 1. RESET (CLOSE EVERYTHING) ---
    const closeAll = () => {
        // A. Mobile Menu (Hamburger)
        const menuBtn = document.querySelector('[data-aw-toggle-menu]');
        if (menuBtn) {
            menuBtn.classList.remove('expanded'); // Wichtig für dein CSS group-[.expanded]
        }
        document.body.classList.remove('overflow-hidden');
        
        const header = document.getElementById('header');
        if (header) {
            header.classList.remove('h-screen', 'expanded', 'bg-page');
            header.querySelector('nav')?.classList.add('hidden');
            header.querySelector('div > div:last-child')?.classList.add('hidden');
        }

        // B. Dropdowns
        document.querySelectorAll('.dropdown').forEach(drop => {
            // Button Status resetten
            const btn = drop.querySelector('button');
            if(btn) btn.classList.remove('expanded');
            
            // Inhalt verstecken (suche nach ul oder div nach dem button)
            const content = drop.querySelector('ul, .dropdown-menu');
            if(content) content.classList.add('hidden');
            // Fallback für einfache Struktur
            else if(btn && btn.nextElementSibling) btn.nextElementSibling.classList.add('hidden');
        });
    };

    // --- 2. THEME ---
    const applyTheme = (theme) => {
      const resolvedTheme = (theme === 'system') 
        ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') 
        : theme;
      
      requestAnimationFrame(() => {
        document.documentElement.classList.toggle('dark', resolvedTheme === 'dark');
        document.querySelectorAll('[data-aw-theme-icon]').forEach((icon) => {
          icon.classList.toggle('hidden', icon.getAttribute('data-aw-theme-icon') !== theme);
        });
      });
    };

    // --- 3. GLOBAL LISTENER ---
    const initGlobalListener = () => {
      
      const handleGlobalClick = (e) => {
        const target = e.target;

        // A) THEME
        if (target.closest('[data-aw-toggle-color-scheme]')) {
            e.preventDefault();
            const themes = ['system', 'light', 'dark'];
            const current = localStorage.getItem('theme') || 'system';
            const next = themes[(themes.indexOf(current) + 1) % 3];
            localStorage.setItem('theme', next);
            applyTheme(next);
            return;
        }

        // B) HAMBURGER BUTTON (Dein Component)
        const menuBtn = target.closest('[data-aw-toggle-menu]');
        if (menuBtn) {
            e.stopPropagation();
            const isExpanded = menuBtn.classList.contains('expanded');
            
            if (isExpanded) {
                closeAll();
            } else {
                // Öffnen
                menuBtn.classList.add('expanded');
                document.body.classList.add('overflow-hidden');
                const header = document.getElementById('header');
                if(header) {
                    header.classList.add('h-screen', 'expanded', 'bg-page');
                    header.querySelector('nav')?.classList.remove('hidden');
                    header.querySelector('div > div:last-child')?.classList.remove('hidden');
                }
            }
            return;
        }

        // C) DROPDOWN BUTTONS
        const dropdownBtn = target.closest('.dropdown > button');
        if (dropdownBtn) {
            e.preventDefault();
            e.stopPropagation(); // Stoppt bubbeln zum Document

            const parent = dropdownBtn.closest('.dropdown');
            const content = parent ? parent.querySelector('ul, .dropdown-menu') : dropdownBtn.nextElementSibling;
            
            const wasOpen = dropdownBtn.classList.contains('expanded');

            // 1. Alle anderen schließen (Accordion)
            document.querySelectorAll('.dropdown').forEach(d => {
                if (d !== parent) {
                    d.querySelector('button')?.classList.remove('expanded');
                    d.querySelector('ul, .dropdown-menu')?.classList.add('hidden');
                }
            });

            // 2. Aktuelles toggeln
            if (wasOpen) {
                dropdownBtn.classList.remove('expanded');
                if(content) content.classList.add('hidden');
            } else {
                dropdownBtn.classList.add('expanded');
                if(content) content.classList.remove('hidden');
            }
            return;
        }

        // D) ECHTE LINKS (Alles schließen + Scrollen)
        const link = target.closest('a');
        if (link) {
            // Ignoriere Links, die eigentlich Dropdown-Trigger sind (fallback)
            if(link.closest('.dropdown') && link.getAttribute('href') === '#') return;

            // ZUERST schließen
            closeAll();

            // DANN Scrollen
            if (link.hash && link.origin === window.location.origin && link.pathname === window.location.pathname) {
                const el = document.querySelector(link.hash);
                if (el) {
                    e.preventDefault();
                    setTimeout(() => {
                        const h = getHeaderHeight();
                        const pos = el.getBoundingClientRect().top + window.scrollY;
                        window.scrollTo({ top: pos - h, behavior: 'smooth' });
                        history.pushState(null, null, link.hash);
                    }, 10);
                }
            }
            return;
        }

        // E) KLICK DANEBEN
        if (!target.closest('#header nav') && !target.closest('[data-aw-toggle-menu]')) {
            closeAll();
        }
      };

      document.addEventListener('click', handleGlobalClick, { capture: true });
      cleanupFns.push(() => document.removeEventListener('click', handleGlobalClick, { capture: true }));
    };

    // --- 4. INIT REST ---
    const initScrollAndAnim = () => {
       const header = document.querySelector('#header[data-aw-sticky-header]');
       if(header) {
           const onScroll = () => header.classList.toggle('scroll', window.scrollY > 10);
           window.addEventListener('scroll', onScroll, {passive: true});
           if(window.scrollY > 10) header.classList.add('scroll');
           cleanupFns.push(() => window.removeEventListener('scroll', onScroll));
       }

       const elements = document.querySelectorAll('.intersect, [class*="intersect:"]');
       if(elements.length) {
           const observer = new IntersectionObserver(entries => {
               entries.forEach(entry => {
                   if(entry.isIntersecting) {
                       entry.target.setAttribute('data-aw-animated', 'true');
                       if (entry.target.classList.contains('intersect-once')) observer.unobserve(entry.target);
                   }
               });
           }, {threshold: 0.1});
           elements.forEach(el => observer.observe(el));
           cleanupFns.push(() => observer.disconnect());
       }
    };

    const run = () => {
      cleanupFns.forEach(fn => fn());
      cleanupFns = [];

      applyTheme(localStorage.getItem('theme') || defaultTheme);
      initScrollAndAnim();
      initGlobalListener();

      if (window.location.hash) {
          const target = document.querySelector(window.location.hash);
          if (target) {
              setTimeout(() => {
                  const h = getHeaderHeight();
                  const pos = target.getBoundingClientRect().top + window.scrollY;
                  window.scrollTo({ top: pos - h, behavior: 'instant' });
              }, 100);
          }
      }
    };

    run();
    document.addEventListener('astro:after-swap', run);
  })();
</script>
