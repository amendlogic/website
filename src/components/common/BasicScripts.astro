---
import { UI } from 'astrowind:config';
---

<script is:inline define:vars={{ defaultTheme: UI.theme || 'system' }}>
  if (window.basic_script_init) return;
  window.basic_script_init = true;

  (function() {
    let cleanupFns = [];

    // --- HELPER: HEADER HÖHE BERECHNEN ---
    const getHeaderHeight = () => {
      const header = document.getElementById('header');
      return header ? header.getBoundingClientRect().height : 0;
    };

    // --- 1. RESET FUNKTION (SCHLIEßT ALLES) ---
    const closeAll = () => {
        // A. Mobile Hamburger Menü zurücksetzen
        const menuBtn = document.querySelector('[data-aw-toggle-menu]');
        if (menuBtn) menuBtn.classList.remove('expanded');
        
        document.body.classList.remove('overflow-hidden');
        const header = document.getElementById('header');
        if (header) {
            header.classList.remove('h-screen', 'expanded', 'bg-page');
            header.querySelector('nav')?.classList.add('hidden');
            header.querySelector('div > div:last-child')?.classList.add('hidden');
        }

        // B. Alle Dropdowns schließen (Desktop & Mobile)
        document.querySelectorAll('.dropdown').forEach(dropdown => {
            const btn = dropdown.querySelector('button');
            const content = dropdown.querySelector('.dropdown-menu');

            if (btn) btn.classList.remove('expanded');
            if (content) {
                content.classList.add('hidden');
                content.classList.add('md:hidden'); // WICHTIG: Urzustand wiederherstellen
            }
        });
    };

    // --- 2. THEME LOGIK (TEMPORÄR) ---
    const applyTheme = (theme) => {
      const resolvedTheme = (theme === 'system') 
        ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') 
        : theme;
      
      requestAnimationFrame(() => {
        document.documentElement.classList.toggle('dark', resolvedTheme === 'dark');
        document.querySelectorAll('[data-aw-theme-icon]').forEach((icon) => {
          icon.classList.toggle('hidden', icon.getAttribute('data-aw-theme-icon') !== theme);
        });
      });
    };

    // --- 3. DER ZENTRALE CLICK-LISTENER ---
    const initGlobalListener = () => {
      
      const handleGlobalClick = (e) => {
        const target = e.target;

        // --- A) THEME TOGGLE ---
        if (target.closest('[data-aw-toggle-color-scheme]')) {
            e.preventDefault();
            const themes = ['system', 'light', 'dark'];
            const current = localStorage.getItem('theme') || 'system';
            const next = themes[(themes.indexOf(current) + 1) % 3];
            localStorage.setItem('theme', next); // Nur für Session, wird bei Reload durch initTheme gelöscht (siehe unten)
            applyTheme(next);
            return;
        }

        // --- B) HAMBURGER TOGGLE (MOBILE) ---
        const menuBtn = target.closest('[data-aw-toggle-menu]');
        if (menuBtn) {
            e.stopPropagation();
            const isExpanded = menuBtn.classList.contains('expanded');
            
            if (isExpanded) {
                closeAll();
            } else {
                menuBtn.classList.add('expanded');
                document.body.classList.add('overflow-hidden');
                const header = document.getElementById('header');
                if (header) {
                    header.classList.add('h-screen', 'expanded', 'bg-page');
                    header.querySelector('nav')?.classList.remove('hidden');
                    header.querySelector('div > div:last-child')?.classList.remove('hidden');
                }
            }
            return;
        }

        // --- C) DROPDOWN TOGGLE (DEIN HTML BUTTON) ---
        const dropdownBtn = target.closest('.dropdown > button');
        if (dropdownBtn) {
            e.preventDefault();
            e.stopPropagation();

            const parent = dropdownBtn.closest('.dropdown');
            // Suche das .dropdown-menu direkt im Parent (sicherer als nextElement)
            const content = parent ? parent.querySelector('.dropdown-menu') : null;
            
            const wasOpen = dropdownBtn.classList.contains('expanded');

            // 1. Alle ANDEREN Dropdowns schließen
            document.querySelectorAll('.dropdown').forEach(d => {
                if (d !== parent) {
                    d.querySelector('button')?.classList.remove('expanded');
                    const c = d.querySelector('.dropdown-menu');
                    if(c) {
                        c.classList.add('hidden');
                        c.classList.add('md:hidden');
                    }
                }
            });

            // 2. Aktuelles Dropdown umschalten
            if (wasOpen) {
                // ZU
                dropdownBtn.classList.remove('expanded');
                if (content) {
                    content.classList.add('hidden');
                    content.classList.add('md:hidden');
                }
            } else {
                // AUF
                dropdownBtn.classList.add('expanded');
                if (content) {
                    content.classList.remove('hidden');
                    // !!! DER FIX: Wir müssen md:hidden entfernen, damit es am Desktop sichtbar wird !!!
                    content.classList.remove('md:hidden');
                }
            }
            return;
        }

        // --- D) ECHTE LINKS (SCHLIEßEN & SCROLLEN) ---
        const link = target.closest('a');
        if (link) {
            // Wenn es ein echter Link ist:
            // 1. ZUERST ALLES SCHLIEßEN
            closeAll();

            // 2. SMOOTH SCROLL LOGIK
            if (link.hash && link.origin === window.location.origin && link.pathname === window.location.pathname) {
                const el = document.querySelector(link.hash);
                if (el) {
                    e.preventDefault();
                    // Timeout gibt dem Browser Zeit, das Menü visuell zu schließen (Layout Update)
                    setTimeout(() => {
                        const headerHeight = getHeaderHeight();
                        const targetPos = el.getBoundingClientRect().top + window.scrollY;
                        window.scrollTo({ top: targetPos - headerHeight, behavior: 'smooth' });
                        // URL Hash aktualisieren ohne Sprung
                        history.pushState(null, null, link.hash);
                    }, 10);
                }
            }
            return;
        }

        // --- E) KLICK DANEBEN (OUTSIDE) ---
        // Wenn Klick nicht im Nav und nicht auf Hamburger -> Alles zu
        if (!target.closest('#header nav') && !target.closest('[data-aw-toggle-menu]')) {
            closeAll();
        }
      };

      document.addEventListener('click', handleGlobalClick, { capture: true });
      cleanupFns.push(() => document.removeEventListener('click', handleGlobalClick, { capture: true }));
    };

    // --- 4. SCROLL & ANIMATIONEN ---
    const initScrollAndAnim = () => {
       const header = document.querySelector('#header[data-aw-sticky-header]');
       if(header) {
           const onScroll = () => header.classList.toggle('scroll', window.scrollY > 10);
           window.addEventListener('scroll', onScroll, {passive: true});
           if(window.scrollY > 10) header.classList.add('scroll');
           cleanupFns.push(() => window.removeEventListener('scroll', onScroll));
       }

       const elements = document.querySelectorAll('.intersect, [class*="intersect:"]');
       if(elements.length) {
           const observer = new IntersectionObserver(entries => {
               entries.forEach(entry => {
                   if(entry.isIntersecting) {
                       entry.target.setAttribute('data-aw-animated', 'true');
                       if (entry.target.classList.contains('intersect-once')) observer.unobserve(entry.target);
                   }
               });
           }, {threshold: 0.1});
           elements.forEach(el => observer.observe(el));
           cleanupFns.push(() => observer.disconnect());
       }
    };

    // --- 5. INITIALISIERUNG ---
    const run = () => {
      cleanupFns.forEach(fn => fn());
      cleanupFns = [];

      // Theme: Keine Persistenz gewünscht, daher localStorage ignorieren oder löschen
      // Aber wenn user klickt, soll es kurz bleiben (HandleGlobalClick speichert es kurz).
      // Beim Neuladen (F5) setzen wir hier auf Default/System zurück:
      applyTheme(defaultTheme); 

      initScrollAndAnim();
      initGlobalListener();

      // RELOAD FIX: Korrekte Position anspringen
      if (window.location.hash) {
          const target = document.querySelector(window.location.hash);
          if (target) {
              setTimeout(() => {
                  const h = getHeaderHeight();
                  const pos = target.getBoundingClientRect().top + window.scrollY;
                  window.scrollTo({ top: pos - h, behavior: 'instant' });
              }, 100);
          }
      }
    };

    run();
    document.addEventListener('astro:after-swap', run);
  })();
</script>
