---
import { UI } from 'astrowind:config';
---

<script is:inline define:vars={{ defaultTheme: UI.theme || 'system' }}>
  if (window.basic_script_init) return;
  window.basic_script_init = true;

  (function() {
    let cleanupFns = [];

    // --- HELPER ---
    const getHeaderHeight = () => {
      const header = document.getElementById('header');
      return header ? header.getBoundingClientRect().height : 0;
    };

    // --- 1. RESET: ALLES SCHLIEßEN (Brute Force Methode) ---
    const closeAll = () => {
        // A. Mobile Hamburger Button & Container
        const menuBtn = document.querySelector('[data-aw-toggle-menu]');
        if (menuBtn) menuBtn.classList.remove('expanded');
        
        document.body.classList.remove('overflow-hidden');
        const header = document.getElementById('header');
        if (header) {
            header.classList.remove('h-screen', 'expanded', 'bg-page');
            header.querySelector('nav')?.classList.add('hidden');
            header.querySelector('div > div:last-child')?.classList.add('hidden');
        }

        // B. Desktop Dropdowns: Buttons zurücksetzen
        document.querySelectorAll('.dropdown > button').forEach(btn => {
            btn.classList.remove('expanded');
        });

        // C. Desktop Dropdowns: Menüs verstecken (Direktzugriff)
        document.querySelectorAll('.dropdown-menu').forEach(ul => {
            ul.classList.add('hidden');
            ul.classList.add('md:hidden'); // WICHTIG für Desktop Reset
        });
    };

    // --- 2. THEME ---
    const applyTheme = (theme) => {
      const resolvedTheme = (theme === 'system') 
        ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') 
        : theme;
      
      requestAnimationFrame(() => {
        document.documentElement.classList.toggle('dark', resolvedTheme === 'dark');
        document.querySelectorAll('[data-aw-theme-icon]').forEach((icon) => {
          icon.classList.toggle('hidden', icon.getAttribute('data-aw-theme-icon') !== theme);
        });
      });
    };

    // --- 3. GLOBAL LISTENER ---
    const initGlobalListener = () => {
      
      const handleGlobalClick = (e) => {
        const target = e.target;

        // A) THEME TOGGLE
        if (target.closest('[data-aw-toggle-color-scheme]')) {
            e.preventDefault();
            const themes = ['system', 'light', 'dark'];
            const current = localStorage.getItem('theme') || 'system';
            const next = themes[(themes.indexOf(current) + 1) % 3];
            localStorage.setItem('theme', next);
            applyTheme(next);
            return;
        }

        // B) HAMBURGER TOGGLE (MOBILE)
        const menuBtn = target.closest('[data-aw-toggle-menu]');
        if (menuBtn) {
            e.stopPropagation();
            if (menuBtn.classList.contains('expanded')) {
                closeAll();
            } else {
                menuBtn.classList.add('expanded');
                document.body.classList.add('overflow-hidden');
                const header = document.getElementById('header');
                if (header) {
                    header.classList.add('h-screen', 'expanded', 'bg-page');
                    header.querySelector('nav')?.classList.remove('hidden');
                    header.querySelector('div > div:last-child')?.classList.remove('hidden');
                }
            }
            return;
        }

        // C) LINK HANDLING (Prio 1: Alles schließen bei echtem Link)
        const link = target.closest('a');
        if (link) {
            const href = link.getAttribute('href');
            // Wenn es KEIN reiner Toggle-Link (#) ist, schließen wir alles.
            if (href && href !== '#' && href !== 'javascript:void(0)') {
                
                // 1. Schließen erzwingen
                closeAll();

                // 2. Smooth Scroll Logic
                if (link.hash && link.origin === window.location.origin && link.pathname === window.location.pathname) {
                    const el = document.querySelector(link.hash);
                    if (el) {
                        e.preventDefault();
                        setTimeout(() => {
                            const headerHeight = getHeaderHeight();
                            const targetPos = el.getBoundingClientRect().top + window.scrollY;
                            window.scrollTo({ top: targetPos - headerHeight, behavior: 'smooth' });
                            history.pushState(null, null, link.hash);
                        }, 10);
                    }
                }
                return; // Hier abbrechen, damit keine Dropdown-Logik mehr feuert
            }
        }

        // D) DROPDOWN TOGGLE (Desktop/Mobile Buttons)
        // Nur feuern, wenn wir NICHT in Fall C gelandet sind (also wenn es ein Button ist oder href="#")
        const dropdownBtn = target.closest('.dropdown > button');
        if (dropdownBtn) {
            e.preventDefault();
            e.stopPropagation();

            const parent = dropdownBtn.closest('.dropdown');
            const content = parent ? parent.querySelector('.dropdown-menu') : null;
            const wasOpen = dropdownBtn.classList.contains('expanded');

            // Erstmal alle anderen schließen
            closeAll(); 

            // Wenn es NICHT offen war, öffnen wir dieses eine wieder
            // (closeAll hat es gerade geschlossen, falls es offen war, also passt die Logik)
            if (!wasOpen) {
                dropdownBtn.classList.add('expanded');
                if (content) {
                    content.classList.remove('hidden');
                    content.classList.remove('md:hidden'); // Desktop sichtbar machen
                }
            }
            return;
        }

        // E) KLICK DANEBEN
        if (!target.closest('#header nav') && !target.closest('[data-aw-toggle-menu]')) {
            closeAll();
        }
      };

      document.addEventListener('click', handleGlobalClick, { capture: true });
      cleanupFns.push(() => document.removeEventListener('click', handleGlobalClick, { capture: true }));
    };

    // --- 4. INIT ---
    const initScrollAndAnim = () => {
       const header = document.querySelector('#header[data-aw-sticky-header]');
       if(header) {
           const onScroll = () => header.classList.toggle('scroll', window.scrollY > 10);
           window.addEventListener('scroll', onScroll, {passive: true});
           if(window.scrollY > 10) header.classList.add('scroll');
           cleanupFns.push(() => window.removeEventListener('scroll', onScroll));
       }

       const elements = document.querySelectorAll('.intersect, [class*="intersect:"]');
       if(elements.length) {
           const observer = new IntersectionObserver(entries => {
               entries.forEach(entry => {
                   if(entry.isIntersecting) {
                       entry.target.setAttribute('data-aw-animated', 'true');
                       if (entry.target.classList.contains('intersect-once')) observer.unobserve(entry.target);
                   }
               });
           }, {threshold: 0.1});
           elements.forEach(el => observer.observe(el));
           cleanupFns.push(() => observer.disconnect());
       }
    };

    const run = () => {
      cleanupFns.forEach(fn => fn());
      cleanupFns = [];

      applyTheme(localStorage.getItem('theme') || defaultTheme);
      initScrollAndAnim();
      initGlobalListener();

      if (window.location.hash) {
          const target = document.querySelector(window.location.hash);
          if (target) {
              setTimeout(() => {
                  const h = getHeaderHeight();
                  const pos = target.getBoundingClientRect().top + window.scrollY;
                  window.scrollTo({ top: pos - h, behavior: 'instant' });
              }, 100);
          }
      }
    };

    run();
    document.addEventListener('astro:after-swap', run);
  })();
</script>
