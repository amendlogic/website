---
import { UI } from 'astrowind:config';
---

<script is:inline define:vars={{ defaultTheme: UI.theme || 'system' }}>
if (window.basic_script_init) return;
window.basic_script_init = true;

(function() {
  let cleanupFns = [];

  // --- DOM CACHE ---
  const docEl = document.documentElement;
  const header = document.getElementById('header');
  const body = document.body;
  const stickyHeader = header?.querySelector('[data-aw-sticky-header]');
  const menuBtn = header?.querySelector('[data-aw-toggle-menu]');
  const nav = header?.querySelector('nav');

  // --- HELPERS ---
  const toggleClass = (el, className, condition) => {
    if (!el) return;
    el.classList.toggle(className, !!condition);
  };

  const applyTheme = (theme) => {
    const resolved = theme === 'system'
      ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light')
      : theme;

    docEl.dataset.theme = resolved;
    toggleClass(docEl, 'dark', resolved === 'dark');

    // Nur zwei Icons toggeln (Hamburger / Close)
    if (menuBtn) {
      const icons = menuBtn.querySelectorAll('svg, [data-aw-icon]');
      if (icons.length > 1) {
        icons[0].classList.toggle('hidden', resolved === 'dark'); // optional: nach Theme
      }
    }
  };

  // --- HEADER SCROLL ---
  const initHeader = () => {
    if (!stickyHeader) return;
    let lastState = window.scrollY > 60;
    toggleClass(stickyHeader, 'scroll', lastState);

    const onScroll = () => {
      const isScrolled = window.scrollY > 60;
      if (isScrolled !== lastState) {
        toggleClass(stickyHeader, 'scroll', isScrolled);
        lastState = isScrolled;
      }
    };

    window.addEventListener('scroll', onScroll, { passive: true });
    cleanupFns.push(() => window.removeEventListener('scroll', onScroll));
  };

  // --- MENU ---
  const initMenu = () => {
    if (!menuBtn || !nav) return;
    menuBtn.setAttribute('aria-expanded', 'false');

    const toggleIcons = (isExpanded) => {
      const icons = menuBtn.querySelectorAll('svg, [data-aw-icon]');
      if (icons.length > 1) {
        icons[0].classList.toggle('hidden', isExpanded);
        icons[1].classList.toggle('hidden', !isExpanded);
      }
    };

    const toggleMenu = () => {
      const isExpanded = menuBtn.classList.toggle('expanded');
      body.classList.toggle('overflow-hidden', isExpanded);
      header.classList.toggle('h-screen', isExpanded);
      header.classList.toggle('expanded', isExpanded);
      header.classList.toggle('bg-page', isExpanded);

      menuBtn.setAttribute('aria-expanded', isExpanded);
      toggleIcons(isExpanded);
      nav.classList.toggle('hidden');

      const actions = header.querySelector('nav + div, div > div:last-child');
      if (actions) actions.classList.toggle('hidden', !isExpanded);
    };

    window.closeMenuInstance = () => {
      if (menuBtn.classList.contains('expanded')) toggleMenu();
    };

    menuBtn.addEventListener('click', toggleMenu);
    cleanupFns.push(() => menuBtn.removeEventListener('click', toggleMenu));

    // Dropdown
    const onNavClick = (e) => {
      const trigger = e.target.closest('.dropdown > button, .dropdown > a');
      if (!trigger || window.getComputedStyle(menuBtn).display === 'none') return;

      e.preventDefault();
      const subMenu = trigger.nextElementSibling;
      if (subMenu) {
        const expanded = subMenu.classList.toggle('hidden') === false;
        trigger.classList.toggle('expanded', expanded);
        trigger.setAttribute('aria-expanded', expanded);
      }
    };

    nav.addEventListener('click', onNavClick);
    cleanupFns.push(() => nav.removeEventListener('click', onNavClick));
  };

  // --- GLOBAL EVENTS ---
  const initGlobalEvents = () => {
    const onClick = (e) => {
      const themeBtn = e.target.closest('[data-aw-toggle-color-scheme]');
      if (themeBtn) {
        const themes = ['system', 'light', 'dark'];
        const current = localStorage.getItem('theme') || 'system';
        const next = themes[(themes.indexOf(current) + 1) % 3];
        localStorage.setItem('theme', next);
        applyTheme(next);
        return;
      }

      const link = e.target.closest('a');
      if (!link || !link.hash || link.origin !== location.origin || link.pathname !== location.pathname) return;

      const decodedHash = decodeURIComponent(link.hash);
      const targetEl = decodedHash === '#' ? null : document.querySelector(decodedHash);
      if (!targetEl) return;

      e.preventDefault();
      link.blur();

      if (header?.classList.contains('expanded') && window.closeMenuInstance) {
        window.closeMenuInstance();
      }

      setTimeout(() => {
        const headerHeight = header?.getBoundingClientRect().height || 0;
        const targetPos = targetEl.getBoundingClientRect().top + window.scrollY;
        window.scrollTo({ top: targetPos - headerHeight, behavior: 'smooth' });
        history.pushState(null, null, link.hash);
      }, 10);
    };

    document.addEventListener('click', onClick, { capture: true, passive: false });
    cleanupFns.push(() => document.removeEventListener('click', onClick, { capture: true }));
  };

  // --- ANIMATIONS ---
  const initAnimations = () => {
    const selectors = ['[class*=" intersect:"]','[class*=":intersect:"]','[class^="intersect:"]','[class="intersect"]','.intersect-once','.intersect-quarter'];
    const elements = document.querySelectorAll(selectors.join(','));
    if (!elements.length) return;

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const el = entry.target;
          el.setAttribute('data-aw-animated', 'true');
          el.removeAttribute('no-intersect');
          if (el.classList.contains('intersect-once')) observer.unobserve(el);
        }
      });
    }, { threshold: 0.1, rootMargin: '0px 0px -10% 0px' });

    elements.forEach(el => {
      el.setAttribute('no-intersect', '');
      observer.observe(el);
    });

    cleanupFns.push(() => observer.disconnect());
  };

  // --- SCROLL FIX ---
  const fixScrollPosition = () => {
    if (!location.hash) return;
    const decodedHash = decodeURIComponent(location.hash);
    const target = decodedHash === '#' ? null : document.querySelector(decodedHash);
    if (!target) return;

    setTimeout(() => {
      const headerHeight = header?.getBoundingClientRect().height || 0;
      const targetPos = target.getBoundingClientRect().top + window.scrollY;
      window.scrollTo({ top: targetPos - headerHeight, behavior: 'instant' });
    }, 50);
  };

  // --- MAIN RUN ---
  const run = () => {
    cleanupFns.forEach(fn => fn());
    cleanupFns = [];

    applyTheme(localStorage.getItem('theme') || 'system');
    initHeader();
    initMenu();
    setTimeout(initGlobalEvents, 0);
    fixScrollPosition();
    if (window.requestIdleCallback) window.requestIdleCallback(initAnimations);
    else setTimeout(initAnimations, 200);
  };

  run();
  document.addEventListener('astro:after-swap', run);
})();
</script>