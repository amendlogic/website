---
// Reusable ECharts Astro Component
// Usage:
// <EChart options={options} height="400px" />

const {
  options,
  width = '100%',
  height = '400px',
  theme = null, // 'dark' | null
  renderer = 'canvas', // 'canvas' | 'svg'
  className = '',
  ariaHidden = true,
} = Astro.props;

if (!options) {
  throw new Error('<EChart /> requires an `options` prop');
}

const chartId = `echart-${Math.random().toString(36).slice(2, 11)}`;
const serializedOptions = JSON.stringify(options);
---

<div
  id={chartId}
  class={className}
  style={`width:${width};height:${height};min-height:${height};`}
  aria-hidden={ariaHidden}
></div>

<script define:vars={{ chartOptions: serializedOptions, chartId, theme, renderer }}>
  let chart;
  let resizeObserver;

  async function initChart() {
    const echarts = await import(
      'https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.esm.min.js'
    );

    const el = document.getElementById(chartId);
    if (!el) return;

    // Dispose existing instance (HMR / transitions safe)
    if (chart) chart.dispose();

    chart = echarts.init(el, theme, { renderer });
    chart.setOption(JSON.parse(chartOptions));

    // ResizeObserver handles hidden/minimized/layout changes
    resizeObserver = new ResizeObserver(entries => {
      for (const entry of entries) {
        const { width, height } = entry.contentRect;
        if (width > 0 && height > 0 && chart) {
          chart.resize();
        }
      }
    });

    resizeObserver.observe(el);
  }

  document.addEventListener('DOMContentLoaded', initChart);

  // Fallback: tab visibility
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible' && chart) {
      requestAnimationFrame(() => chart.resize());
    }
  });

  // Cleanup
  window.addEventListener('beforeunload', () => {
    resizeObserver?.disconnect();
    chart?.dispose();
  });
</script>
