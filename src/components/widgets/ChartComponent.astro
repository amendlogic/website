---
import WidgetWrapper from '~/components/ui/WidgetWrapper.astro';
import Headline from '~/components/ui/Headline.astro';

const {
  title = await Astro.slots.render('title'),
  subtitle = await Astro.slots.render('subtitle'),
  tagline = await Astro.slots.render('tagline'),

  width = '100%',
  height = '400px',
  options = {},

  id,
  isDark = false,
  classes = {},
  isBeforeContent,
  isAfterContent,
  bg = await Astro.slots.render('bg'),
} = Astro.props;

// Generate unique chart ID
const chartId = `echart-${Math.random().toString(36).slice(2, 11)}`;

// Default options
const defaultOptions = {
  title: { text: 'ECharts Example' },
  tooltip: {},
  xAxis: { data: ['A', 'B', 'C', 'D', 'E'] },
  yAxis: {},
  series: [{ type: 'bar', data: [5, 20, 36, 10, 10] }],
};

const chartOptions =
  Object.keys(options).length > 0 ? options : defaultOptions;

const serializedOptions = JSON.stringify(chartOptions);
---

<WidgetWrapper id={id} isDark={isDark} containerClass={`max-w-6xl mx-auto ${classes?.container ?? ''}`} bg={bg}>
  <Headline
    title={title}
    subtitle={subtitle}
    tagline={tagline}
    classes={classes?.headline as Record<string, string>}
  />
  <div
    id={chartId}
    style={`width:${width};height:${height};`}
    aria-hidden="true"
  />
</WidgetWrapper>

<script define:vars={{ chartOptions: serializedOptions, chartId }}>
  let chart;

  async function initChart() {
    const echarts = await import(
      'https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.esm.min.js'
    );

    const el = document.getElementById(chartId);
    if (!el) return;

    // Falls bereits vorhanden â†’ neu initialisieren
    if (chart) {
      chart.dispose();
    }

    chart = echarts.init(el);
    chart.setOption(JSON.parse(chartOptions));
    chart.resize();
  }

  document.addEventListener('DOMContentLoaded', initChart);

  // ðŸ”¹ Re-render bei Tab-Wechsel / Minimierung
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible' && chart) {
      requestAnimationFrame(() => chart.resize());
    }
  });

  // ðŸ”¹ Re-render bei Fokus (z. B. Alt+Tab)
  window.addEventListener('focus', () => {
    if (chart) {
      requestAnimationFrame(() => chart.resize());
    }
  });

  // ðŸ”¹ Window resize (debounced light)
  let resizeTimeout;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
      if (chart) chart.resize();
    }, 100);
  });
</script>

