---
import WidgetWrapper from '~/components/ui/WidgetWrapper.astro';
import Headline from '~/components/ui/Headline.astro';

const {
  title = await Astro.slots.render('title'),
  subtitle = await Astro.slots.render('subtitle'),
  tagline = await Astro.slots.render('tagline'),

  width = '100%',
  height = '400px',
  options = {},

  id,
  isDark = false,
  classes = {},
  isBeforeContent,
  isAfterContent,
  bg = await Astro.slots.render('bg'),
} = Astro.props;

// Generate unique chart ID
const chartId = `echart-${Math.random().toString(36).slice(2, 11)}`;

// Default options
const defaultOptions = {
  title: { text: 'ECharts Example' },
  tooltip: {},
  xAxis: { data: ['A', 'B', 'C', 'D', 'E'] },
  yAxis: {},
  series: [{ type: 'bar', data: [5, 20, 36, 10, 10] }],
};

const chartOptions =
  Object.keys(options).length > 0 ? options : defaultOptions;

const serializedOptions = JSON.stringify(chartOptions);
---

<WidgetWrapper
  id={id}
  isDark={isDark}
  bg={bg}
  containerClass={`${isBeforeContent ? 'md:pb-8 lg:pb-12' : ''} ${
    isAfterContent ? 'pt-0 md:pt-0 lg:pt-0' : ''
  } ${classes?.container ?? ''}`}
>
  <Headline
    title={title}
    subtitle={subtitle}
    tagline={tagline}
    classes={classes?.headline as Record<string, string>}
  />

  <div
    id={chartId}
    style={`width:${width};height:${height};`}
    aria-hidden="true"
    class="flex flex-col max-w-xl mx-auto rounded-lg backdrop-blur border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-900 shadow p-4 sm:p-6 lg:p-8 w-full"
  />
</WidgetWrapper>

<script define:vars={{ chartOptions: serializedOptions, chartId }}>
  document.addEventListener('DOMContentLoaded', async () => {
    const echarts = await import(
      'https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.esm.min.js'
    );

    const el = document.getElementById(chartId);
    if (!el) return;

    const chart = echarts.init(el);
    chart.setOption(JSON.parse(chartOptions));

    window.addEventListener('resize', () => chart.resize());
  });
</script>

