---
import WidgetWrapper from '~/components/ui/WidgetWrapper.astro';
import Headline from '~/components/ui/Headline.astro';
import type { Stats as Props } from '~/types';

const {
  title = await Astro.slots.render('title'),
  subtitle = await Astro.slots.render('subtitle'),
  tagline = await Astro.slots.render('tagline'),
  stats = [],

  width = '100%',
  height = '400px',
  options = {},

  id,
  isDark = false,
  classes = {},
  isBeforeContent,
  isAfterContent,
  bg = await Astro.slots.render('bg'),
} = Astro.props;

// Generate unique chart ID
const chartId = `echart-${Math.random().toString(36).slice(2, 11)}`;

// Default options
const defaultOptions = {
  title: { text: 'ECharts Example' },
  tooltip: {},
  xAxis: { data: ['A', 'B', 'C', 'D', 'E'] },
  yAxis: {},
  series: [{ type: 'bar', data: [5, 20, 36, 10, 10] }],
};

const chartOptions =
  Object.keys(options).length > 0 ? options : defaultOptions;

const serializedOptions = JSON.stringify(chartOptions);
---

<WidgetWrapper id={id} isDark={isDark} containerClass={`max-w-6xl mx-auto ${classes?.container ?? ''}`} bg={bg}>
  <Headline
    title={title}
    subtitle={subtitle}
    tagline={tagline}
    classes={classes?.headline as Record<string, string>}
  />
  <div class="flex flex-wrap justify-center -m-4 text-center">
    {
      stats &&
        stats.map(({ amount, title, icon }) => (
          <div class="p-4 md:w-1/4 sm:w-1/2 w-full min-w-[220px] text-center md:border-r md:last:border-none dark:md:border-slate-500 intersect-once motion-safe:md:opacity-0 motion-safe:md:intersect:animate-fade intersect-quarter">
            {icon && (
              <div class="flex items-center justify-center mx-auto mb-4 text-primary">
                <Icon name={icon} class="w-10 h-10" />
              </div>
            )}
            {amount && (
              <div class="font-heading text-primary text-[2.6rem] font-bold dark:text-white lg:text-5xl xl:text-6xl">
                {amount}
              </div>
            )}
            {title && (
              <div class="text-sm font-medium uppercase tracking-widest text-gray-800 dark:text-slate-400 lg:text-base">
                {title}
              </div>
            )}
          </div>
        ))
    }
  </div>
  <div
    id={chartId}
    style={`width:${width};height:${height};`}
    aria-hidden="true"
  />
</WidgetWrapper>

<script define:vars={{ chartOptions: serializedOptions, chartId }}>
  document.addEventListener('DOMContentLoaded', async () => {
    const echarts = await import(
      'https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.esm.min.js'
    );

    const el = document.getElementById(chartId);
    if (!el) return;

    const chart = echarts.init(el);
    chart.setOption(JSON.parse(chartOptions));

    window.addEventListener('resize', () => chart.resize());
  });
</script>

