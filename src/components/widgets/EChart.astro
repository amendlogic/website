---
/* src/components/widgets/ChartWidget.astro */
import WidgetWrapper from '~/components/ui/WidgetWrapper.astro';
import Headline from '~/components/ui/Headline.astro';
import { parseCsvData, getBaseChartOptions } from '~/lib/chart-data';

const {
  title = await Astro.slots.render('title'),
  subtitle = await Astro.slots.render('subtitle'),
  tagline,
  content = await Astro.slots.render('content'),
  options: userOptions = {},
  initialCapital = 300,
  csvPath,
  height = '450px',
  id,
  locale = Astro.currentLocale || 'de',
  isDark = false,
  classes = {},
  bg = await Astro.slots.render('bg'),
} = Astro.props;

// IDs
const uid = Math.random().toString(36).slice(2, 9);
const wrapperId = id ?? `widget-${uid}`;
const chartId = `chart-${uid}`;
const dataId = `data-${uid}`;

// --- SERVER SIDE ---
// Daten holen
const parsedData = await parseCsvData(csvPath, Number(initialCapital));
// Config erstellen
const baseOptions = getBaseChartOptions(parsedData);
---

<WidgetWrapper id={wrapperId} isDark={isDark} containerClass={`max-w-6xl mx-auto ${classes?.container ?? ''}`} bg={bg}>
  <Headline title={title} subtitle={subtitle} tagline={tagline} />
  {content && <div class="mb-12 text-lg dark:text-slate-400" set:html={content} />}

  <div class="p-4 md:p-6 rounded-md shadow-xl dark:border dark:border-slate-600 bg-white dark:bg-slate-900">
    {baseOptions ? (
      <div 
        id={chartId} 
        data-json-id={dataId}
        class="w-full overflow-hidden" 
        style={`height:${height};`}
      ></div>
    ) : (
      <div class="flex items-center justify-center h-64 text-slate-400 bg-slate-50 dark:bg-slate-800/50 rounded border border-dashed border-slate-300 dark:border-slate-700">
        <span class="text-sm">Keine Daten verfügbar.</span>
      </div>
    )}
  </div>
</WidgetWrapper>

{baseOptions && (
  <script type="application/json" id={dataId} set:html={JSON.stringify({ baseOptions, userOptions, locale })} />
)}

<script>
  import { initChartWidget, cleanup } from '/lib/chart-widget';

  // Astro Lifecycle Events
  document.addEventListener('astro:page-load', initChartWidget);
  document.addEventListener('astro:before-swap', cleanup);
  
  // Falls Skript inline ausgeführt wird (ohne View Transitions)
  if (document.readyState !== 'loading') initChartWidget();
</script>
