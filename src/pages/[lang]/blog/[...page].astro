---
import type { InferGetStaticPropsType, GetStaticPaths } from 'astro';
import Layout from '~/layouts/PageLayout.astro';
import BlogList from '~/components/blog/List.astro';
import Headline from '~/components/blog/Headline.astro';
import Pagination from '~/components/blog/Pagination.astro';

import { getCollection } from 'astro:content';
import { LANGUAGES } from '~/i18n/config'; // Oder wo deine Sprachen definiert sind
import { APP_BLOG } from 'astrowind:config';

export const prerender = true;

export const getStaticPaths = (async ({ paginate }) => {
  const allPosts = await getCollection('post');
  const posts = allPosts.sort((a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf());

  // Wir müssen für JEDE Sprache eine eigene Pagination erstellen
  return Object.keys(LANGUAGES).flatMap((lang) => {
    
    // 1. Filtern: Nur Posts dieser Sprache
    const langPosts = posts.filter((post) => post.id.startsWith(`${lang}/`));

    // 2. Paginieren: Astro erstellt automatisch Seite 1, 2, 3...
    return paginate(langPosts, {
      params: { lang }, // WICHTIG: Das 'lang' Parameter weitergeben
      pageSize: APP_BLOG.postsPerPage || 6, // Anzahl aus der Config nehmen
    });
  });
}) satisfies GetStaticPaths;

type Props = InferGetStaticPropsType<typeof getStaticPaths>;

const { page } = Astro.props;
const { lang } = Astro.params;

const currentPage = page.currentPage ?? 1;

const metadata = {
  title: `Blog ${currentPage > 1 ? ` — Page ${currentPage}` : ''}`,
  robots: {
    index: true, // Blog soll indexiert werden
    follow: true,
  },
  openGraph: {
    type: 'blog',
  },
};
---

<Layout metadata={metadata}>
  <section class="px-6 sm:px-6 py-12 sm:py-16 lg:py-20 mx-auto max-w-4xl">
    <Headline
      subtitle={lang === 'de' 
        ? 'Neuigkeiten, Tutorials und Ressourcen für dein Trading.' 
        : 'A statically generated blog example with news, tutorials, and resources.'}
    >
      {lang === 'de' ? 'Der Blog' : 'The Blog'}
    </Headline>
    
    <BlogList posts={page.data} />

    <Pagination prevUrl={page.url.prev} nextUrl={page.url.next} />
    
  </section>
</Layout>
