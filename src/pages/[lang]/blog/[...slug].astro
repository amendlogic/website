---
import { fetchPosts, getRelatedPosts, blogPostRobots } from '~/utils/blog'; // WICHTIG: Import aus utils/blog
import merge from 'lodash.merge';
import type { ImageMetadata } from 'astro';

import Layout from '~/layouts/PageLayout.astro';
import SinglePost from '~/components/blog/SinglePost.astro';
import ToBlogLink from '~/components/blog/ToBlogLink.astro';
import RelatedPosts from '~/components/blog/RelatedPosts.astro';

import { getCanonical, getPermalink } from '~/utils/permalinks';
import type { MetaData } from '~/types';

export const prerender = true;

export async function getStaticPaths() {
  // 1. Alle Posts holen (die sind durch blog.ts schon sauber verarbeitet!)
  const posts = await fetchPosts();

  // 2. Pfade generieren
  return posts.map((post) => ({
    params: { 
      lang: post.lang, // 'en' oder 'de' (kommt jetzt sauber aus blog.ts)
      slug: post.slug  // 'mein-post' (ohne .md, ohne Ordner)
    },
    props: { post },
  }));
}

const { post } = Astro.props;
const { lang } = Astro.params;

const url = getCanonical(getPermalink(post.permalink, 'post', lang));

// Content rendern
const { Content } = await post.Content.render ? await post.Content.render() : { Content: post.Content }; 
// HINWEIS: In der neuen blog.ts geben wir Content direkt zur√ºck, 
// falls 'Content' eine Komponente ist, nutze einfach <post.Content /> unten.
// Da wir in blog.ts "Content" direkt aus "render(entry)" holen, ist es eine Komponente.

const metadata = merge(
  {
    title: post.title,
    description: post.excerpt,
    robots: {
      index: blogPostRobots?.index,
      follow: blogPostRobots?.follow,
    },
    openGraph: {
      type: 'article',
      image: post.image,
    },
  },
  { ...(post?.metadata ? { ...post.metadata, canonical: post.metadata?.canonical || url } : {}) }
) as MetaData;
---

<Layout metadata={metadata}>
  <SinglePost post={post} url={url}>
    <post.Content />
  </SinglePost>
  
  <ToBlogLink />
  
  <RelatedPosts post={post} />
</Layout>
