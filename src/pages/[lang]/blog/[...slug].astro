---
import type { InferGetStaticPropsType, GetStaticPaths } from 'astro';
import merge from 'lodash.merge';
import type { ImageMetadata } from 'astro';
import Layout from '~/layouts/PageLayout.astro';
import SinglePost from '~/components/blog/SinglePost.astro';
import ToBlogLink from '~/components/blog/ToBlogLink.astro';
import { getCanonical, getPermalink } from '~/utils/permalinks';
import { getStaticPathsBlogPost, blogPostRobots } from '~/utils/blog';
import { findImage } from '~/utils/images';
import type { MetaData } from '~/types';
import RelatedPosts from '~/components/blog/RelatedPosts.astro';
import { Icon } from 'astro-icon/components';

export const prerender = true;

export const getStaticPaths = (async () => {
  // NUR NOCH POSTS, KEINE LISTE MEHR!
  return await getStaticPathsBlogPost();
}) satisfies GetStaticPaths;

type Props = InferGetStaticPropsType<typeof getStaticPaths>;

const { post } = Astro.props as Props;
const { lang } = Astro.params;

// Fallback Logik
const isFallbackContent = post.lang !== lang;
const fallbackMessage = lang === 'de' 
  ? `Dieser Artikel ist leider noch nicht auf Deutsch verfügbar. Wir zeigen dir daher die englische Version.`
  : `This article is currently not available in your language. We are displaying the original version.`;

const url = getCanonical(getPermalink(post.permalink, 'post', lang));
const image = await findImage(post.image);

const metadata = merge(
  {
    title: post.title,
    description: post.excerpt,
    robots: {
      index: blogPostRobots?.index,
      follow: blogPostRobots?.follow,
    },
    openGraph: {
      type: 'article',
      ...(image
        ? { images: [{ url: image, width: (image as ImageMetadata)?.width, height: (image as ImageMetadata)?.height }] }
        : {}),
    },
  },
  { ...(post.metadata ? { ...post.metadata, canonical: post.metadata?.canonical || url } : {}) }
) as MetaData;
---

<Layout metadata={metadata}>
  {isFallbackContent && (
      <div class="max-w-3xl mx-auto px-4 sm:px-6 mb-8">
        <div class="flex items-center bg-blue-50 dark:bg-slate-800 border-l-4 border-blue-500 dark:border-blue-700 p-4 rounded-r shadow-sm" role="alert">
          <div class="flex-shrink-0">
            <svg class="h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
            </svg>
          </div>
          <div class="ml-3">
            <p class="text-sm text-blue-800 dark:text-blue-200 font-medium">
              {lang === 'de' 
                ? 'Dieser Inhalt ist aktuell nur auf Englisch verfügbar.' 
                : 'This content is currently only available in German.'}
            </p>
          </div>
        </div>
      </div>
  )}

  <SinglePost post={{ ...post, image: image }} url={url}>
    {post.Content ? <post.Content /> : <Fragment set:html={post.content || ''} />}
  </SinglePost>
  
  <ToBlogLink />
  <RelatedPosts post={post} />
</Layout>
